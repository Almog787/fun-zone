<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>VOXEL COMMANDER PRO - Cinematic Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #0f172a; font-family: 'Segoe UI', sans-serif; }
        #ui {
            position: absolute; top: 20px; left: 20px; color: #38bdf8;
            pointer-events: none; z-index: 10; background: rgba(15, 23, 42, 0.8);
            padding: 20px; border-radius: 15px; border: 1px solid #1e293b;
        }
        /* כפתורי מצלמה */
        #controls {
            position: absolute; bottom: 30px; left: 30px; display: grid;
            grid-template-columns: 50px 50px 50px; gap: 10px; z-index: 100;
        }
        .btn {
            width: 50px; height: 50px; background: #1e293b; color: #38bdf8;
            border: 1px solid #38bdf8; border-radius: 10px; cursor: pointer;
            display: flex; justify-content: center; align-items: center; font-weight: bold;
            user-select: none; transition: 0.2s;
        }
        .btn:active { background: #38bdf8; color: #1e293b; }
        .btn-audio {
            position: absolute; top: 20px; right: 20px; background: #ef4444;
            color: white; border: none; padding: 12px 24px; cursor: pointer;
            border-radius: 8px; font-weight: bold; z-index: 100;
        }
        #instructions { position: absolute; bottom: 20px; width: 100%; text-align: center; color: #94a3b8; pointer-events: none; }
    </style>
</head>
<body>

    <div id="ui">
        <h1 style="margin:0; font-size: 24px;">VOXEL COMMANDER PRO</h1>
        <div id="status">מערכת נשק: מוכנה | סוללה: מלאה</div>
    </div>

    <div id="controls">
        <div></div><div class="btn" onmousedown="moveCam('up')">▲</div><div></div>
        <div class="btn" onmousedown="moveCam('left')">◀</div>
        <div class="btn" onmousedown="moveCam('down')">▼</div>
        <div class="btn" onmousedown="moveCam('right')">▶</div>
    </div>

    <div id="instructions">לחץ על בניין לירי | השתמש בחצים לניווט</div>
    <button class="btn-audio" id="audioBtn" onclick="initAudio()">הפעל מערכות סאונד</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>

    <script>
        /** 1. מנוע סאונד מתקדם **/
        let audioCtx = null;
        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            document.getElementById('audioBtn').style.display = 'none';
        }

        function playSound(type) {
            if (!audioCtx) return;
            const now = audioCtx.currentTime;
            const master = audioCtx.createGain();
            master.connect(audioCtx.destination);

            if (type === 'launch') {
                const osc = audioCtx.createOscillator();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.2);
                const g = audioCtx.createGain();
                g.gain.setValueAtTime(0.3, now);
                g.gain.linearRampToValueAtTime(0, now + 0.2);
                osc.connect(g); g.connect(master);
                osc.start(); osc.stop(now + 0.2);
            } 
            else if (type === 'whistle') {
                const osc = audioCtx.createOscillator();
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(300, now + 0.8);
                const g = audioCtx.createGain();
                g.gain.setValueAtTime(0, now);
                g.gain.linearRampToValueAtTime(0.1, now + 0.1);
                g.gain.linearRampToValueAtTime(0, now + 0.8);
                osc.connect(g); g.connect(master);
                osc.start(); osc.stop(now + 0.8);
            }
            else if (type === 'explode') {
                const noise = audioCtx.createBufferSource();
                const buf = audioCtx.createBuffer(1, audioCtx.sampleRate * 2, audioCtx.sampleRate);
                const d = buf.getChannelData(0);
                for (let i = 0; i < buf.length; i++) d[i] = Math.random() * 2 - 1;
                noise.buffer = buf;
                const filter = audioCtx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(1000, now);
                filter.frequency.exponentialRampToValueAtTime(40, now + 0.5);
                const g = audioCtx.createGain();
                g.gain.setValueAtTime(0.5, now);
                g.gain.exponentialRampToValueAtTime(0.01, now + 1.5);
                noise.connect(filter); filter.connect(g); g.connect(master);
                noise.start();
            }
        }

        /** 2. אתחול עולם **/
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020617);
        scene.fog = new THREE.Fog(0x020617, 100, 600);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
        let camAngle = 0.5;
        let camHeight = 80;
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.4));
        const sun = new THREE.DirectionalLight(0xffffff, 1);
        sun.position.set(100, 200, 100);
        scene.add(sun);

        const grid = new THREE.GridHelper(1000, 60, 0x1e293b, 0x0f172a);
        scene.add(grid);

        /** 3. בניית עיר משופרת **/
        const buildings = [];
        const debris = [];
        const voxelGeo = new THREE.BoxGeometry(1.9, 1.9, 1.9);

        function createCity() {
            for (let i = 0; i < 40; i++) {
                const bx = (Math.random() - 0.5) * 250;
                const bz = (Math.random() - 0.5) * 250;
                const bh = Math.floor(Math.random() * 10) + 5;
                const bw = Math.floor(Math.random() * 2) + 2;
                
                const group = new THREE.Group();
                const voxels = [];
                
                for(let y=0; y<bh; y++) {
                    for(let x=0; x<bw; x++) {
                        for(let z=0; z<bw; z++) {
                            // חלונות מוארים באקראי
                            const isWindow = Math.random() > 0.85;
                            const mat = new THREE.MeshStandardMaterial({ 
                                color: isWindow ? 0xfff380 : 0x334155,
                                emissive: isWindow ? 0xfff380 : 0x000000,
                                emissiveIntensity: isWindow ? 1 : 0
                            });
                            const v = new THREE.Mesh(voxelGeo, mat);
                            v.position.set(x*2, y*2 + 1, z*2);
                            group.add(v);
                            voxels.push(v);
                        }
                    }
                }
                group.position.set(bx, 0, bz);
                scene.add(group);
                buildings.push({ group, voxels, destroyed: false });
            }
        }
        createCity();

        /** 4. שליטת מצלמה **/
        function moveCam(dir) {
            if (dir === 'left') camAngle += 0.2;
            if (dir === 'right') camAngle -= 0.2;
            if (dir === 'up') camHeight = Math.min(camHeight + 10, 200);
            if (dir === 'down') camHeight = Math.max(camHeight - 10, 20);
        }

        /** 5. ירי ופגיעה מדויקת **/
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('mousedown', (e) => {
            if (e.target.className === 'btn') return; // אל תירה כשלוחצים על כפתור
            
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            
            // בדיקת פגיעה בכל המבנים
            const intersects = raycaster.intersectObjects(scene.children, true);
            if (intersects.length > 0) {
                const target = intersects[0].point;
                // מציאת המבנה הנכון
                let hitB = null;
                buildings.forEach(b => {
                    if (b.group === intersects[0].object.parent || b.group === intersects[0].object) hitB = b;
                });
                launch(target, hitB);
            }
        });

        function launch(target, building) {
            playSound('launch');
            playSound('whistle');

            // ציור פגז משופר (טיל עם שובל)
            const shellGroup = new THREE.Group();
            const head = new THREE.Mesh(new THREE.SphereGeometry(1.2), new THREE.MeshBasicMaterial({color: 0xffffff}));
            const trail = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 0.1, 5), new THREE.MeshBasicMaterial({color: 0x38bdf8, transparent: true, opacity: 0.5}));
            trail.rotation.x = Math.PI / 2;
            trail.position.z = 2.5;
            shellGroup.add(head);
            shellGroup.add(trail);
            
            shellGroup.position.set(camera.position.x, camera.position.y - 10, camera.position.z);
            scene.add(shellGroup);
            shellGroup.lookAt(target);

            gsap.to(shellGroup.position, {
                x: target.x, y: target.y, z: target.z,
                duration: 0.8, ease: "power2.in",
                onComplete: () => {
                    scene.remove(shellGroup);
                    detonate(target, building);
                }
            });
        }

        function detonate(pos, building) {
            playSound('explode');

            // פיצוץ ויזואלי
            const light = new THREE.PointLight(0xffaa00, 20, 100);
            light.position.copy(pos);
            scene.add(light);
            gsap.to(light, { intensity: 0, duration: 0.6, onComplete: () => scene.remove(light) });

            if (building && !building.destroyed) {
                building.destroyed = true;
                building.voxels.forEach((v) => {
                    const worldPos = new THREE.Vector3();
                    v.getWorldPosition(worldPos);
                    scene.attach(v);
                    
                    const angle = Math.random() * Math.PI * 2;
                    const force = 2 + Math.random() * 3;
                    v.userData.velocity = new THREE.Vector3(Math.cos(angle) * force, 3 + Math.random() * 4, Math.sin(angle) * force);
                    v.userData.active = true;
                    debris.push(v);

                    v.material.emissive.setHex(0xff4400);
                    v.material.emissiveIntensity = 2;
                    gsap.to(v.material.color, { r: 0.1, g: 0.1, b: 0.1, duration: 3 });
                });
            }

            // רעידת מצלמה
            gsap.fromTo(camera.position, { x: camera.position.x + 3 }, { x: camera.position.x, duration: 0.1, ease: "elastic.out" });
        }

        /** 6. לולאת אנימציה **/
        function animate() {
            requestAnimationFrame(animate);
            
            // עדכון מצלמה לפי כפתורים
            const targetX = Math.cos(camAngle) * 300;
            const targetZ = Math.sin(camAngle) * 300;
            camera.position.lerp(new THREE.Vector3(targetX, camHeight, targetZ), 0.1);
            camera.lookAt(0, 0, 0);

            // פיזיקת רסיסים
            for (let i = debris.length - 1; i >= 0; i--) {
                const v = debris[i];
                if (v.userData.active) {
                    v.position.add(v.userData.velocity);
                    v.userData.velocity.y -= 0.2; // כבידה
                    v.userData.velocity.multiplyScalar(0.96); // חיכוך

                    if (v.position.y < 1) {
                        v.position.y = 1;
                        v.userData.velocity.set(0,0,0);
                        v.userData.active = false;
                    }
                }
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
