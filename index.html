<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOXEL COMMANDER - JSON Engine</title>
    <style>
        body { margin: 0; overflow: hidden; background: #020617; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        #ui {
            position: absolute; top: 20px; left: 20px; color: #f8fafc;
            pointer-events: none; z-index: 100;
        }

        #hud {
            border-left: 4px solid #38bdf8;
            padding-left: 15px;
            background: rgba(15, 23, 42, 0.7);
            padding: 20px;
            border-radius: 0 10px 10px 0;
            backdrop-filter: blur(5px);
        }

        h1 { margin: 0; font-size: 24px; letter-spacing: 2px; color: #38bdf8; text-transform: uppercase; }
        .stats { font-family: monospace; font-size: 14px; color: #94a3b8; margin-top: 5px; }
        
        #loading-screen {
            position: absolute; width: 100%; height: 100%; background: #020617;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #38bdf8; z-index: 1000; transition: opacity 0.5s;
        }

        .loader {
            border: 4px solid #1e293b;
            border-top: 4px solid #38bdf8;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        canvas { display: block; cursor: crosshair; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loader"></div>
        <div id="loading-text">מתחבר למערכת הנתונים...</div>
    </div>

    <div id="ui">
        <div id="hud">
            <h1 id="level-title">VOXEL COMMAND</h1>
            <div class="stats" id="level-info">Initializing System...</div>
            <div class="stats" id="target-info">Targeting: Standby</div>
        </div>
    </div>

    <!-- ספריות חיצוניות -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>

    <script>
        /** מנוע המשחק **/
        let scene, camera, renderer, raycaster, mouse;
        let levelData, explosionData;
        const buildings = [];
        const voxelsInWorld = [];

        // 1. טעינת נתונים אסינכרונית
        async function init() {
            try {
                const [resLvl, resExp] = await Promise.all([
                    fetch('level.json'),
                    fetch('explosion.json')
                ]);

                if (!resLvl.ok || !resExp.ok) throw new Error("JSON files not found");

                levelData = await resLvl.json();
                explosionData = await resExp.json();

                // עדכון UI
                document.getElementById('level-title').innerText = levelData.metadata.levelName;
                document.getElementById('level-info').innerText = `מבנים: ${levelData.buildings.length} | כבידה: ${levelData.physics.gravity}`;
                
                setupScene();
                createCity();
                
                document.getElementById('loading-screen').style.opacity = '0';
                setTimeout(() => document.getElementById('loading-screen').remove(), 500);
                
                animate();
            } catch (err) {
                document.getElementById('loading-text').innerText = "שגיאת טעינה: וודא שהקבצים קיימים ומורצים על שרת";
                console.error(err);
            }
        }

        // 2. הגדרת עולם תלת-ממדי
        function setupScene() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(levelData.environment.skyColor);
            scene.fog = new THREE.FogExp2(levelData.environment.skyColor, levelData.environment.fogDensity);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(100, 70, 120);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // תאורה מה-JSON
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x1e293b, levelData.environment.ambientIntensity);
            scene.add(hemiLight);

            const sun = new THREE.DirectionalLight(
                levelData.environment.sunlight.color, 
                levelData.environment.sunlight.intensity
            );
            sun.position.set(
                levelData.environment.sunlight.position.x,
                levelData.environment.sunlight.position.y,
                levelData.environment.sunlight.position.z
            );
            scene.add(sun);

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            window.addEventListener('mousedown', onFire);
            window.addEventListener('resize', onWindowResize);
        }

        // 3. בניית העיר המורחבת
        function createCity() {
            const grid = new THREE.GridHelper(500, 100, levelData.environment.gridColor, 0x1e293b);
            scene.add(grid);

            const voxelGeo = new THREE.BoxGeometry(1.9, 1.9, 1.9);

            levelData.buildings.forEach(b => {
                const group = new THREE.Group();
                const buildingVoxels = [];
                
                for (let y = 0; y < b.h; y++) {
                    for (let x = 0; x < (b.w || 3); x++) {
                        for (let z = 0; z < (b.d || 3); z++) {
                            const mat = new THREE.MeshStandardMaterial({ 
                                color: b.color, 
                                metalness: 0.6, 
                                roughness: 0.2 
                            });
                            const mesh = new THREE.Mesh(voxelGeo, mat);
                            
                            // חישוב מיקום יחסי (מרכוז)
                            const ox = ((b.w || 3) - 1);
                            const oz = ((b.d || 3) - 1);
                            
                            mesh.position.set(x * 2 - ox, y * 2 + 1, z * 2 - oz);
                            group.add(mesh);
                            buildingVoxels.push(mesh);
                        }
                    }
                }
                group.position.set(b.x, 0, b.z);
                scene.add(group);
                buildings.push({ group, voxels: buildingVoxels, destroyed: false, name: b.name });
            });
        }

        // 4. לוגיקת ירי
        function onFire(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children, true);

            if (intersects.length > 0) {
                const target = intersects[0].point;
                document.getElementById('target-info').innerText = `Target Locked: ${target.x.toFixed(0)}, ${target.z.toFixed(0)}`;
                
                // מציאת המבנה הנפגע
                let hitBuilding = null;
                buildings.forEach(b => {
                    if (intersects[0].object.parent === b.group) hitBuilding = b;
                });

                launchProjectile(target, hitBuilding);
            }
        }

        function launchProjectile(target, building) {
            const shell = new THREE.Mesh(
                new THREE.SphereGeometry(1.2, 16, 16),
                new THREE.MeshBasicMaterial({ color: 0xffdd00 })
            );
            shell.position.set(120, 60, 120); // נקודת מוצא הארטילריה
            scene.add(shell);

            const duration = levelData.physics.shellSpeed;

            // מסלול בליסטי
            gsap.to(shell.position, {
                x: target.x, z: target.z,
                duration: duration,
                ease: "none",
                onComplete: () => {
                    scene.remove(shell);
                    detonate(target, building);
                }
            });

            gsap.to(shell.position, {
                y: target.y + 40,
                duration: duration / 2,
                yoyo: true, repeat: 1,
                ease: "power1.out"
            });
        }

        // 5. פירוק ופיזיקה (Baking Physics מ-JSON)
        function detonate(pos, building) {
            // פלאש פיצוץ
            const flash = new THREE.PointLight(0xffaa00, explosionData.flashIntensity, 80);
            flash.position.copy(pos);
            scene.add(flash);
            gsap.to(flash, { intensity: 0, duration: 0.6, onComplete: () => scene.remove(flash) });

            if (building && !building.destroyed) {
                building.destroyed = true;
                
                building.voxels.forEach((v, i) => {
                    // שימוש בנתונים מתוך explosion.json (בלולאה)
                    const data = explosionData.shards[i % explosionData.shards.length];
                    
                    const worldPos = new THREE.Vector3();
                    v.getWorldPosition(worldPos);
                    scene.attach(v); // ניתוק מהקבוצה של הבניין

                    // פיזיקה מבוססת JSON
                    gsap.to(v.position, {
                        x: worldPos.x + Math.cos(data.angle) * (data.vel * (levelData.physics.explosionForce / 10)),
                        z: worldPos.z + Math.sin(data.angle) * (data.vel * (levelData.physics.explosionForce / 10)),
                        y: worldPos.y + Math.random() * levelData.physics.explosionForce,
                        duration: 1.5,
                        delay: data.delay,
                        ease: "expo.out"
                    });

                    // נפילה חזרה (כבידה מה-JSON)
                    gsap.to(v.position, {
                        y: 1,
                        duration: 1.2,
                        delay: data.delay + 0.8,
                        ease: "bounce.out"
                    });

                    // אפקט חריכה
                    v.material.emissive.setHex(0xff3300);
                    gsap.to(v.material.color, { r: 0.05, g: 0.05, b: 0.05, duration: 2, delay: 1 });
                });
            }

            // רעידת מסך
            gsap.fromTo(camera.position, 
                { x: camera.position.x + 2 }, 
                { x: camera.position.x, duration: 0.05, repeat: 10, yoyo: true }
            );
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            
            // תנועה איטית של המצלמה
            const t = Date.now() * 0.0001;
            camera.position.x = Math.cos(t) * 150;
            camera.position.z = Math.sin(t) * 150;
            camera.lookAt(0, 0, 0);

            renderer.render(scene, camera);
        }

        // הפעלה
        init();

    </script>
</body>
</html>
