<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Bus Live - GitHub Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700&display=swap');
        body { font-family: 'Assistant', sans-serif; }
        #map { height: calc(100vh - 80px); width: 100%; }
        .bus-icon {
            background-color: #3b82f6; border: 2px solid white; border-radius: 50%;
            text-align: center; color: white; font-weight: bold; font-size: 11px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
    </style>
</head>
<body class="bg-gray-100 overflow-hidden">

    <header class="bg-blue-900 text-white p-4 shadow-lg flex flex-wrap justify-between items-center z-[1001] relative">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-black italic tracking-tighter text-blue-100">STRIDE <span class="text-blue-400 font-bold">LIVE</span></h1>
            <div id="status" class="text-xs bg-blue-800 px-3 py-1 rounded-full italic font-bold">טוען...</div>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 bg-blue-800 p-1 px-3 rounded-lg border border-blue-700">
                <label for="refresh-rate" class="text-xs font-bold text-blue-200">רענון:</label>
                <select id="refresh-rate" onchange="updateRefreshInterval(this.value)" class="bg-transparent text-white text-sm outline-none font-bold">
                    <option value="10000" selected>10 שניות</option>
                    <option value="30000">30 שניות</option>
                </select>
            </div>
            <button onclick="fetchBuses()" class="bg-blue-500 hover:bg-blue-400 text-white px-4 py-1 rounded-lg font-bold text-sm shadow-md">רענן כעת</button>
        </div>
    </header>

    <div class="flex flex-col md:flex-row h-screen">
        <aside class="w-full md:w-80 bg-white shadow-xl z-10 overflow-hidden hidden md:flex flex-col" style="height: calc(100vh - 80px);">
            <div id="bus-list" class="flex-1 overflow-y-auto p-4 space-y-2">
                <p class="text-gray-400 text-center py-10 italic">מתחבר לשרתי הנתונים...</p>
            </div>
        </aside>
        <div class="flex-1 relative">
            <div id="map"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        let busMarkers = {};
        let refreshTimer = null;
        let currentRate = 10000;

        const map = L.map('map', { zoomControl: false }).setView([32.0853, 34.7818], 12);
        L.control.zoom({ position: 'bottomleft' }).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const STRIDE_QUERY = `
        query {
          siri_vehicle_locations(order_by: {recorded_at_time: desc}, limit: 100) {
            id
            latitude
            longitude
            recorded_at_time
            siri_ride {
              gtfs_ride {
                gtfs_route {
                  route_short_name
                  route_long_name
                }
              }
            }
          }
        }`;

        async function fetchBuses() {
            const statusEl = document.getElementById('status');
            statusEl.innerText = "מעדכן...";
            
            // שימוש בפרוקסי לעקיפת חסימת CORS
            const proxy = "https://corsproxy.io/?";
            const targetUrl = "https://open-bus-stride-api.hasadna.org.il/graphql";
            
            try {
                const response = await fetch(proxy + encodeURIComponent(targetUrl), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: STRIDE_QUERY })
                });

                if (!response.ok) throw new Error("Server Error");

                const result = await response.json();
                const buses = result.data.siri_vehicle_locations;
                
                updateMap(buses);
                updateList(buses);
                
                statusEl.innerText = `עודכן: ${new Date().toLocaleTimeString('he-IL')}`;
                statusEl.className = "text-xs bg-green-700 px-3 py-1 rounded-full";
            } catch (error) {
                console.error("CORS Bypass Error:", error);
                statusEl.innerText = "שגיאת חיבור (CORS)";
                statusEl.className = "text-xs bg-red-700 px-3 py-1 rounded-full";
            }
        }

        function updateMap(buses) {
            const currentIds = buses.map(b => b.id);
            Object.keys(busMarkers).forEach(id => {
                if (!currentIds.includes(parseInt(id))) {
                    map.removeLayer(busMarkers[id]);
                    delete busMarkers[id];
                }
            });

            buses.forEach(bus => {
                if (!bus.latitude || !bus.longitude) return;
                const routeName = bus.siri_ride?.gtfs_ride?.gtfs_route?.route_short_name || "?";
                
                if (busMarkers[bus.id]) {
                    busMarkers[bus.id].setLatLng([bus.latitude, bus.longitude]);
                } else {
                    const icon = L.divIcon({
                        className: 'bus-icon',
                        html: `<div>${routeName}</div>`,
                        iconSize: [26, 26]
                    });
                    const marker = L.marker([bus.latitude, bus.longitude], { icon: icon })
                        .bindPopup(`<b>קו ${routeName}</b><br>${bus.siri_ride?.gtfs_ride?.gtfs_route?.route_long_name || ''}`);
                    marker.addTo(map);
                    busMarkers[bus.id] = marker;
                }
            });
        }

        function updateList(buses) {
            const listContainer = document.getElementById('bus-list');
            listContainer.innerHTML = buses.slice(0, 40).map(bus => `
                <div class="p-3 bg-white border rounded-lg shadow-sm hover:border-blue-500 cursor-pointer transition-all" 
                     onclick="focusBus(${bus.latitude}, ${bus.longitude}, ${bus.id})">
                    <div class="font-black text-blue-600 italic">קו ${bus.siri_ride?.gtfs_ride?.gtfs_route?.route_short_name || '?'}</div>
                    <div class="text-[10px] text-gray-500 truncate">${bus.siri_ride?.gtfs_ride?.gtfs_route?.route_long_name || ''}</div>
                </div>
            `).join('');
        }

        function focusBus(lat, lng, id) {
            map.setView([lat, lng], 16);
            if (busMarkers[id]) busMarkers[id].openPopup();
        }

        function updateRefreshInterval(val) {
            currentRate = parseInt(val);
            if (refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(fetchBuses, currentRate);
            fetchBuses();
        }

        // הפעלה
        fetchBuses();
        refreshTimer = setInterval(fetchBuses, currentRate);
    </script>
</body>
</html>
