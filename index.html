<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>" 住  转 - 砖专</title>
    
    <!-- Tailwind CSS 注爪 专 -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS - 驻转 转  -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700&display=swap');
        body { font-family: 'Assistant', sans-serif; margin: 0; padding: 0; }
        #map { height: calc(100vh - 70px); width: 100%; }
        
        /* 注爪 拽 砖 住 注 驻 */
        .bus-div-icon {
            background: #2563eb;
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
            width: 26px !important;
            height: 26px !important;
        }
    </style>
</head>
<body class="bg-gray-50 overflow-hidden">

    <!-- Header -->
    <header class="bg-blue-700 text-white h-[70px] px-6 flex justify-between items-center shadow-md relative z-[1000]">
        <div class="flex items-center gap-3">
            <div class="text-2xl"></div>
            <h1 class="text-xl font-bold tracking-tight">住  转 <span class="text-blue-200 font-light">砖专</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <div id="status" class="text-[10px] bg-blue-800 px-3 py-1 rounded-full border border-blue-600">注 转...</div>
            <button onclick="fetchData()" class="bg-white text-blue-700 px-4 py-1 rounded-lg text-sm font-bold hover:bg-blue-50 transition">专注</button>
        </div>
    </header>

    <main class="flex">
        <!-- Sidebar -->
        <aside class="w-80 bg-white border-l shadow-xl hidden md:flex flex-col z-[500]" style="height: calc(100vh - 70px);">
            <div class="p-4 bg-gray-50 border-b">
                <h2 class="font-bold text-gray-700 text-sm italic"> 专 (SIRI)</h2>
            </div>
            <div id="bus-list" class="flex-1 overflow-y-auto divide-y divide-gray-100">
                <!--  转驻注 专砖转 住 -->
                <p class="p-4 text-gray-400 text-sm italic">驻砖 砖专 GPS...</p>
            </div>
        </aside>

        <!-- Map Container -->
        <div id="map" class="flex-1"></div>
    </main>

    <script>
        // --- 专转 驻 ---
        // 拽 专砖 注 砖专
        const map = L.map('map', { zoomControl: false }).setView([32.0853, 34.7818], 12);
        
        // 注转 砖转 驻 ( -OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        L.control.zoom({ position: 'bottomleft' }).addTo(map);

        let markers = {}; // 砖专 转 专拽专 注 驻 注转 驻转

        // --- 砖转转 GraphQL 砖专转 住专 ---
        const STRIDE_ENDPOINT = "https://open-bus-stride-api.hasadna.org.il/graphql";
        
        const query = `
        query {
          siri_vehicle_locations(order_by: {recorded_at_time: desc}, limit: 150) {
            id
            latitude
            longitude
            recorded_at_time
            velocity
            siri_ride {
              gtfs_ride {
                gtfs_route {
                  route_short_name
                  route_long_name
                }
              }
            }
          }
        }`;

        // --- 驻拽爪转 砖转 转 ---
        async function fetchData() {
            const statusEl = document.getElementById('status');
            statusEl.innerText = "注...";

            try {
                // 驻 砖专 -API  驻专拽住
                const response = await fetch(STRIDE_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });

                const result = await response.json();
                const buses = result.data.siri_vehicle_locations;

                updateUI(buses);
                statusEl.innerText = `注: ${new Date().toLocaleTimeString('he-IL')}`;
            } catch (error) {
                console.error("Error:", error);
                statusEl.innerText = "砖转 转拽砖专转";
            }
        }

        // --- 注 驻 专砖 ---
        function updateUI(buses) {
            const listContainer = document.getElementById('bus-list');
            listContainer.innerHTML = ""; // 拽 专砖

            // 专砖转 IDs 砖注 注砖
            const currentIds = buses.map(b => b.id);

            // 住专转 专拽专 砖 砖 爪 " 专
            Object.keys(markers).forEach(id => {
                if (!currentIds.includes(parseInt(id))) {
                    map.removeLayer(markers[id]);
                    delete markers[id];
                }
            });

            buses.forEach(bus => {
                if (!bus.latitude || !bus.longitude) return;

                const routeName = bus.siri_ride?.gtfs_ride?.gtfs_route?.route_short_name || "?";
                const longName = bus.siri_ride?.gtfs_ride?.gtfs_route?.route_long_name || "拽  ";
                const lastSeen = new Date(bus.recorded_at_time).toLocaleTimeString('he-IL');

                // 1. 注 驻
                if (markers[bus.id]) {
                    //  住 专 注 驻, 专拽  转
                    markers[bus.id].setLatLng([bus.latitude, bus.longitude]);
                } else {
                    // 爪专转 拽 注 住驻专 拽
                    const icon = L.divIcon({
                        className: 'bus-div-icon',
                        html: `<div>${routeName}</div>`,
                        iconSize: [26, 26]
                    });

                    const marker = L.marker([bus.latitude, bus.longitude], { icon: icon })
                        .bindPopup(`<b>拽 ${routeName}</b><br>${longName}<br><small>注: ${lastSeen}</small>`);
                    
                    marker.addTo(map);
                    markers[bus.id] = marker;
                }

                // 2. 注 专砖 爪
                const item = document.createElement('div');
                item.className = "p-3 hover:bg-blue-50 cursor-pointer transition text-sm";
                item.innerHTML = `
                    <div class="flex justify-between font-bold text-blue-800">
                        <span>拽 ${routeName}</span>
                        <span class="text-[10px] text-gray-400">${lastSeen}</span>
                    </div>
                    <div class="text-[11px] text-gray-500 truncate">${longName}</div>
                `;
                item.onclick = () => {
                    map.setView([bus.latitude, bus.longitude], 16);
                    markers[bus.id].openPopup();
                };
                listContainer.appendChild(item);
            });
        }

        // --- 驻注 转 ---
        fetchData();
        setInterval(fetchData, 15000); // 专注   15 砖转

    </script>
</body>
</html>
