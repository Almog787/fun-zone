<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMERGENCY RADAR 3D | STABLE</title>
    
    <!-- Tailwind & FontAwesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- CesiumJS -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Orbitron:wght@400;900&display=swap');
        
        body, html { margin: 0; padding: 0; height: 100%; background: #000; overflow: hidden; color: #00ff41; font-family: 'JetBrains Mono', monospace; }

        #cesiumContainer { width: 100%; height: 100%; position: absolute; }

        /* HUD Styles */
        .hud { position: absolute; inset: 0; pointer-events: none; z-index: 10; display: flex; flex-direction: column; }
        .interactive { pointer-events: auto; }
        .panel { background: rgba(5, 15, 5, 0.85); backdrop-filter: blur(8px); border: 1px solid rgba(0, 255, 65, 0.3); }
        
        /* Scanline Effect */
        .scanline { width: 100%; height: 100%; position: absolute; background: linear-gradient(to bottom, transparent 50%, rgba(0, 255, 65, 0.02) 50%); background-size: 100% 4px; z-index: 11; pointer-events: none; }
        
        .emergency-blink { animation: blink-red 1s infinite alternate; }
        @keyframes blink-red { from { color: #ff0000; } to { color: #550000; } }
        
        .orbitron { font-family: 'Orbitron', sans-serif; }
        .cinema-mode .hide-cinema { display: none !important; }
    </style>
</head>
<body>

    <div id="cesiumContainer"></div>
    <div class="scanline"></div>

    <div class="hud">
        <!-- Header -->
        <header class="h-16 panel border-b flex justify-between items-center px-6 hide-cinema">
            <div class="flex items-center gap-4">
                <i class="fas fa-satellite-dish text-xl animate-pulse"></i>
                <div>
                    <h1 class="orbitron text-lg font-black tracking-widest text-white">TACTICAL_RADAR_3D</h1>
                    <p class="text-[8px] uppercase tracking-[0.4em] text-green-500/60">Global Sensor Grid Active</p>
                </div>
            </div>
            <div class="flex items-center gap-6 interactive font-bold text-[10px]">
                <button onclick="toggleAudio()" id="audioBtn" class="hover:text-white"><i class="fas fa-volume-up"></i> SFX: ON</button>
                <button onclick="toggleCinema()" class="hover:text-white"><i class="fas fa-compress"></i> CINEMA</button>
                <div id="clock" class="orbitron text-lg text-white">00:00:00</div>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="w-72 panel m-4 rounded-xl flex flex-col interactive hide-cinema overflow-hidden" style="max-height: 70vh;">
            <div class="p-3 bg-green-900/20 border-b border-green-900/30 text-[10px] font-black uppercase flex justify-between">
                <span>Signal_Log</span>
                <span class="text-red-500 animate-pulse">● LIVE</span>
            </div>
            <div id="log-feed" class="flex-1 overflow-y-auto p-3 space-y-3 text-[9px] leading-relaxed">
                <div class="text-white opacity-50">> Booting System...</div>
                <div class="text-white opacity-50">> Map Ready.</div>
            </div>
        </aside>

        <!-- Stats Footer -->
        <div class="mt-auto p-4 flex justify-center hide-cinema">
            <div class="panel rounded-full px-10 py-3 flex gap-8 interactive border-green-500/20 shadow-2xl">
                <div class="text-center">
                    <div class="text-[8px] uppercase opacity-60">Emergencies</div>
                    <div id="count-7700" class="orbitron text-xl text-red-500 font-bold">0</div>
                </div>
                <div class="text-center border-x border-green-900/30 px-8">
                    <div class="text-[8px] uppercase opacity-60">Global Feed</div>
                    <div id="count-total" class="orbitron text-xl text-green-400 font-bold">0</div>
                </div>
                <div class="text-center">
                    <div class="text-[8px] uppercase opacity-60">Seismic</div>
                    <div id="count-quake" class="orbitron text-xl text-orange-400 font-bold">0</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Cesium Initialization (FIXED) ---
        // שימוש במפת OpenStreetMap כדי למנוע שגיאות טעינה שנובעות מחוסר ב-Token
        const viewer = new Cesium.Viewer('cesiumContainer', {
            imageryProvider: new Cesium.OpenStreetMapImageryProvider({
                url : 'https://a.tile.openstreetmap.org/'
            }),
            baseLayerPicker: false,
            geocoder: false,
            homeButton: false,
            infoBox: false,
            sceneModePicker: false,
            selectionIndicator: false,
            timeline: false,
            animation: false,
            navigationHelpButton: false,
            scene3DOnly: true,
            creditContainer: document.createElement('div') // מסתיר את קרדיט ברירת המחדל לטובת מראה נקי
        });

        // החלת פילטר צבעים כהה על המפה
        viewer.scene.light = new Cesium.DirectionalLight({
            direction: new Cesium.Cartesian3(1, 0, -1)
        });
        
        // --- Audio Engine ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let audioEnabled = true;

        function playPing() {
            if (!audioEnabled) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(1000, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.4);
        }

        // --- Logic & Data ---
        async function updateData() {
            try {
                // מטוסים בחירום
                const res = await fetch('https://opensky-network.org/api/states/all');
                const data = await res.json();
                const allStates = data.states || [];
                const emergencies = allStates.filter(s => s[14] === "7700");

                document.getElementById('count-total').innerText = allStates.length;
                document.getElementById('count-7700').innerText = emergencies.length;

                viewer.entities.removeAll(); // ניקוי מרקרים ישנים

                if (emergencies.length > 0) {
                    playPing();
                    emergencies.forEach(p => {
                        renderPoint(p[6], p[5], p[7] || 10000, p[1], true);
                        addLog(`SQUAWK 7700: Flight ${p[1]}`, 'red');
                    });
                }

                // רעידות אדמה
                const qRes = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/4.5_day.geojson');
                const qData = await qRes.json();
                document.getElementById('count-quake').innerText = qData.features.length;
                qData.features.slice(0, 5).forEach(q => {
                    const c = q.geometry.coordinates;
                    renderPoint(c[1], c[0], 0, `MAG ${q.properties.mag}`, false);
                });

            } catch (e) {
                addLog("CONNECTION_ERROR: Retrying...", "red");
            }
        }

        function renderPoint(lat, lon, alt, label, isEmergency) {
            viewer.entities.add({
                position: Cesium.Cartesian3.fromDegrees(lon, lat, alt),
                point: {
                    pixelSize: isEmergency ? 12 : 6,
                    color: isEmergency ? Cesium.Color.RED : Cesium.Color.fromCssColorString('#00ff41'),
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 1
                },
                label: {
                    text: label,
                    font: '10px monospace',
                    fillColor: Cesium.Color.WHITE,
                    pixelOffset: new Cesium.Cartesian2(0, -15),
                    distanceDisplayCondition: new Cesium.DistanceDisplayCondition(0, 2000000)
                }
            });
        }

        function addLog(msg, color) {
            const feed = document.getElementById('log-feed');
            const div = document.createElement('div');
            div.className = color === 'red' ? 'text-red-500 font-bold' : 'text-green-400';
            div.innerHTML = `> [${new Date().toLocaleTimeString()}] ${msg}`;
            feed.prepend(div);
        }

        function toggleAudio() {
            audioEnabled = !audioEnabled;
            document.getElementById('audioBtn').innerHTML = audioEnabled ? '<i class="fas fa-volume-up"></i> SFX: ON' : '<i class="fas fa-volume-mute"></i> SFX: OFF';
        }

        function toggleCinema() {
            document.body.classList.toggle('cinema-mode');
        }

        // --- Loops ---
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('he-IL');
        }, 1000);

        updateData();
        setInterval(updateData, 60000); // עדכון כל דקה

    </script>
</body>
</html>
