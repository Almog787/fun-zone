<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Earth Destroyer: Cinema Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; user-select: none; }
        
        /* ××¡×š ×¤×ª×™×—×” (×—×•×‘×” ×‘×©×‘×™×œ ×¡××•× ×“) */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center;
        }
        #start-btn {
            padding: 20px 50px; font-size: 24px; background: #f44336; color: white;
            border: none; border-radius: 50px; cursor: pointer; margin-top: 20px;
            box-shadow: 0 0 30px #f44336; transition: transform 0.2s;
            font-weight: bold; text-transform: uppercase;
        }
        #start-btn:hover { transform: scale(1.1); }

        /* ×××©×§ ××©×ª××© */
        #ui-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
            z-index: 10;
        }

        /* ×‘×¨ ×‘×¨×™××•×ª */
        #health-container { width: 100%; padding: 20px; box-sizing: border-box; text-align: center; }
        #health-bar-bg {
            width: 100%; max-width: 600px; height: 30px; background: rgba(20, 20, 20, 0.8);
            border: 2px solid #555; border-radius: 15px; margin: 0 auto; overflow: hidden; position: relative;
        }
        #health-bar-fill {
            width: 100%; height: 100%; background: linear-gradient(90deg, #4caf50, #ffeb3b, #f44336);
            transition: width 0.2s ease-out;
        }
        #health-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-weight: bold; text-shadow: 1px 1px 2px black; font-size: 14px;
        }

        /* ×‘×—×™×¨×ª × ×©×§ */
        #weapon-selector {
            display: flex; justify-content: center; gap: 15px; padding: 30px;
            pointer-events: auto; background: linear-gradient(to top, rgba(0,0,0,1), transparent);
            flex-wrap: wrap;
        }
        .weapon-btn {
            background: rgba(30, 30, 30, 0.8); border: 1px solid #666; color: #ddd;
            padding: 15px; border-radius: 12px; cursor: pointer; font-size: 14px;
            transition: all 0.2s; display: flex; flex-direction: column; align-items: center;
            width: 80px;
        }
        .weapon-btn.active { 
            border-color: #f44336; background: rgba(244, 67, 54, 0.2); 
            box-shadow: 0 0 15px rgba(244, 67, 54, 0.5); color: white; transform: translateY(-5px);
        }
        .weapon-icon { font-size: 28px; margin-bottom: 5px; }

        /* ××¡×š ×¡×™×•× */
        #game-over {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); display: none;
            flex-direction: column; justify-content: center; align-items: center;
            pointer-events: auto; z-index: 100;
        }
        #game-over h1 { 
            color: #f44336; font-size: 60px; text-transform: uppercase; margin: 0; 
            letter-spacing: 5px; text-shadow: 0 0 20px red;
        }
        
        #flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0; pointer-events: none; transition: opacity 0.1s; z-index: 50;
        }
    </style>
    <!-- ×¡×¤×¨×™×•×ª ×’×¨×¤×™×§×” -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
</head>
<body>

    <!-- ××¡×š ×¤×ª×™×—×” (×—×•×‘×” ×œ××•×“×™×•) -->
    <div id="start-screen">
        <h1 style="font-size: 40px; margin-bottom: 10px;">EARTH DESTROYER</h1>
        <p>×”×©××“ ××ª ×”×›×“×•×¨ ×¢× ××¨×¡× ×œ × ×©×§×™×</p>
        <button id="start-btn" onclick="startGame()">×”×ª×—×œ ××©×™××”</button>
    </div>

    <div id="flash"></div>

    <div id="ui-container">
        <div id="health-container">
            <div id="health-bar-bg">
                <div id="health-bar-fill"></div>
                <span id="health-text">××¦×‘ ×”×›×•×›×‘: 100%</span>
            </div>
        </div>

        <div id="weapon-selector">
            <button class="weapon-btn active" onclick="selectWeapon('laser')">
                <span class="weapon-icon">âš¡</span> ×œ×™×™×–×¨
            </button>
            <button class="weapon-btn" onclick="selectWeapon('asteroid')">
                <span class="weapon-icon">â˜„ï¸</span> ××¡×˜×¨×•××™×“
            </button>
            <button class="weapon-btn" onclick="selectWeapon('nuke')">
                <span class="weapon-icon">â˜¢ï¸</span> ×’×¨×¢×™× ×™
            </button>
            <button class="weapon-btn" onclick="selectWeapon('monster')">
                <span class="weapon-icon">ğŸ‘¾</span> ×—×™×™×–×¨
            </button>
        </div>
    </div>

    <div id="game-over">
        <h1>×”××©×™××” ×”×•×©×œ××”</h1>
        <p style="color: #aaa; margin-bottom: 20px;">×›×“×•×¨ ×”××¨×¥ ×”×•×©××“ ×‘×”×¦×œ×—×”</p>
        <button id="start-btn" onclick="resetGame()">××ª×—×•×œ ××¢×¨×›×ª</button>
    </div>

    <script>
        // --- ××¢×¨×›×ª ×¡××•× ×“ ××ª×§×“××ª (×§×‘×¦×™×) ---
        const sounds = {
            bgMusic: new Audio('https://labs.phaser.io/assets/audio/tech/sci-fi_platformer04.mp3'),
            laser: 'https://labs.phaser.io/assets/audio/SoundEffects/blaster.mp3',
            explosion_small: 'https://labs.phaser.io/assets/audio/SoundEffects/explosion.mp3',
            explosion_big: 'https://labs.phaser.io/assets/audio/SoundEffects/explode1.wav', // ×¡××•× ×“ ×¢××•×§
            monster: 'https://labs.phaser.io/assets/audio/monsters/golem_groan.mp3',
            impact: 'https://labs.phaser.io/assets/audio/SoundEffects/squit.mp3'
        };

        sounds.bgMusic.loop = true;
        sounds.bgMusic.volume = 0.3;

        function playSfx(type) {
            let src = '';
            let vol = 1.0;

            if (type === 'laser') src = sounds.laser;
            else if (type === 'asteroid') { src = sounds.explosion_small; vol = 0.6; }
            else if (type === 'nuke') src = sounds.explosion_big;
            else if (type === 'monster') src = sounds.monster;
            else if (type === 'impact') src = sounds.impact;

            if (src) {
                const audio = new Audio(src);
                audio.volume = vol;
                // ×©×™× ×•×™ ××”×™×¨×•×ª ××§×¨××™ ×§×˜×Ÿ ×œ×’×™×•×•×Ÿ
                audio.playbackRate = 0.9 + Math.random() * 0.2;
                audio.play().catch(e => console.log('Audio blocked', e));
            }
        }

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            sounds.bgMusic.play().catch(e => console.log("Background music blocked"));
        }

        // --- ×’×¨×¤×™×§×” (Three.js) ---
        const scene = new THREE.Scene();
        // ×¢×¨×¤×œ ×—×œ×œ ×œ×¨×§×¢
        scene.fog = new THREE.FogExp2(0x000000, 0.02);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 4;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio); // ×—×“×•×ª ×‘×˜×œ×¤×•× ×™×
        renderer.toneMapping = THREE.ReinhardToneMapping;
        document.body.appendChild(renderer.domElement);

        // ×ª××•×¨×” ×“×¨××˜×™×ª
        const ambientLight = new THREE.AmbientLight(0x222222);
        scene.add(ambientLight);
        const sunLight = new THREE.DirectionalLight(0xffffff, 1.5);
        sunLight.position.set(5, 3, 5);
        scene.add(sunLight);
        const rimLight = new THREE.SpotLight(0x0044ff, 2); // ××•×¨ ×›×—×•×œ ×××—×•×¨
        rimLight.position.set(-5, 0, -5);
        rimLight.lookAt(0,0,0);
        scene.add(rimLight);

        // --- ×›×“×•×¨ ×”××¨×¥ ---
        const texLoader = new THREE.TextureLoader();
        const earthGroup = new THREE.Group();
        scene.add(earthGroup);

        const geometry = new THREE.IcosahedronGeometry(1, 12); // ×’×™××•××˜×¨×™×” ××•×¨×›×‘×ª ×œ×¤×™×¨×•×§
        const material = new THREE.MeshStandardMaterial({
            map: texLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_atmos_2048.jpg'),
            normalMap: texLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_normal_2048.jpg'),
            roughness: 0.8,
            metalness: 0.1,
            vertexColors: true
        });

        // ××ª×—×•×œ ×¦×‘×¢×™× ×œ×’×™××•××˜×¨×™×” (×œ×‘×Ÿ)
        const count = geometry.attributes.position.count;
        geometry.setAttribute('color', new THREE.BufferAttribute(new Float32Array(count * 3), 3));
        const colors = geometry.attributes.color;
        for (let i = 0; i < count; i++) colors.setXYZ(i, 1, 1, 1);

        const earth = new THREE.Mesh(geometry, material);
        earthGroup.add(earth);

        // ×¢× × ×™× × ×¤×¨×“×™×
        const cloudGeo = new THREE.SphereGeometry(1.02, 64, 64);
        const cloudMat = new THREE.MeshStandardMaterial({
            map: texLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_clouds_1024.png'),
            transparent: true,
            opacity: 0.4,
            blending: THREE.AdditiveBlending,
            side: THREE.DoubleSide
        });
        const clouds = new THREE.Mesh(cloudGeo, cloudMat);
        earthGroup.add(clouds);

        // ××˜××•×¡×¤×™×¨×”
        const atmoGeo = new THREE.SphereGeometry(1.2, 64, 64);
        const atmoMat = new THREE.ShaderMaterial({
            transparent: true, side: THREE.BackSide,
            uniforms: {},
            vertexShader: `varying vec3 vNormal; void main(){vNormal=normalize(normalMatrix*normal);gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}`,
            fragmentShader: `varying vec3 vNormal; void main(){float i=pow(0.5-dot(vNormal,vec3(0,0,1.0)),4.0);gl_FragColor=vec4(0.2,0.5,1.0,1.0)*i;}`
        });
        const atmosphere = new THREE.Mesh(atmoGeo, atmoMat);
        scene.add(atmosphere);

        // ×—×œ×§×™×§×™ ×›×•×›×‘×™×
        const starGeo = new THREE.BufferGeometry();
        const starPos = [];
        for(let i=0; i<3000; i++) {
            starPos.push((Math.random()-0.5)*100, (Math.random()-0.5)*100, (Math.random()-0.5)*100);
        }
        starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
        const stars = new THREE.Points(starGeo, new THREE.PointsMaterial({color: 0xffffff, size: 0.05}));
        scene.add(stars);

        // --- ×œ×•×’×™×§×ª ××©×—×§ ---
        let currentWeapon = 'laser';
        let health = 100;
        let isGameOver = false;
        let shake = 0;

        function selectWeapon(w) {
            currentWeapon = w;
            document.querySelectorAll('.weapon-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        // Raycaster ×œ×–×™×”×•×™ ×¤×’×™×¢×”
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('pointerdown', (e) => {
            if (isGameOver) return;
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(earth);
            if (intersects.length > 0) handleHit(intersects[0]);
        });

        function handleHit(hit) {
            const p = hit.point;
            
            if (currentWeapon === 'laser') {
                shootLaser(p);
                damageEarth(p, 5, 0.15, [0.1, 0.1, 0.1]); // ×—×¨×™×›×” ×©×—×•×¨×”
            } 
            else if (currentWeapon === 'asteroid') {
                launchAsteroid(p); // ×”× ×–×§ ×§×•×¨×” ×‘×¤×’×™×¢×”
            } 
            else if (currentWeapon === 'nuke') {
                launchNuke(p);
            } 
            else if (currentWeapon === 'monster') {
                spawnMonster(p);
            }
        }

        // --- ××¤×§×˜×™× ---

        function shootLaser(target) {
            playSfx('laser');
            // ×§×¨×Ÿ ×œ×™×™×–×¨
            const geo = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(target.x*2, target.y*2, 5), target]);
            const line = new THREE.Line(geo, new THREE.LineBasicMaterial({ color: 0x00ffff, linewidth: 3 }));
            scene.add(line);
            
            // ×¤×™×¦×•×¥ ×§×˜×Ÿ
            createParticles(target, 0x00ffff, 10);
            
            gsap.to(line.material, { opacity: 0, duration: 0.2, onComplete: () => scene.remove(line) });
        }

        function launchAsteroid(target) {
            const rock = new THREE.Mesh(
                new THREE.DodecahedronGeometry(0.15, 0),
                new THREE.MeshStandardMaterial({ color: 0x885522, roughness: 1 })
            );
            const start = target.clone().normalize().multiplyScalar(5);
            rock.position.copy(start);
            scene.add(rock);

            gsap.to(rock.position, {
                x: target.x, y: target.y, z: target.z, duration: 0.6, ease: "power1.in",
                onUpdate: () => rock.rotation.x += 0.2,
                onComplete: () => {
                    scene.remove(rock);
                    playSfx('asteroid');
                    createParticles(target, 0xffaa00, 30);
                    damageEarth(target, 12, 0.25, [0.3, 0.1, 0]); // ××›×ª×© ×—×•×
                    shake += 0.2;
                }
            });
        }

        function launchNuke(target) {
            const missile = new THREE.Mesh(
                new THREE.CylinderGeometry(0.02, 0.02, 0.3),
                new THREE.MeshBasicMaterial({ color: 0xffffff })
            );
            missile.position.copy(target.clone().multiplyScalar(4));
            missile.lookAt(target);
            scene.add(missile);

            gsap.to(missile.position, {
                x: target.x, y: target.y, z: target.z, duration: 0.8,
                onComplete: () => {
                    scene.remove(missile);
                    playSfx('nuke');
                    createParticles(target, 0xff5500, 100); // ×¤×™×¦×•×¥ ×¢× ×§
                    
                    // ×”×‘×–×§ ×œ×‘×Ÿ
                    const flash = document.getElementById('flash');
                    flash.style.opacity = 1;
                    gsap.to(flash.style, { opacity: 0, duration: 1 });

                    damageEarth(target, 35, 0.5, [0, 0, 0]); // ×©×¨×•×£ ×œ×’××¨×™
                    shake += 0.8;
                }
            });
        }

        function spawnMonster(target) {
            playSfx('monster');
            const tentacles = [];
            for(let i=0; i<5; i++) {
                const t = new THREE.Mesh(
                    new THREE.ConeGeometry(0.05, 0.8, 8),
                    new THREE.MeshStandardMaterial({ color: 0x8800ff })
                );
                t.position.copy(target);
                t.lookAt(target.clone().multiplyScalar(2));
                t.rotation.z += Math.random();
                scene.add(t);
                tentacles.push(t);
                
                gsap.to(t.scale, { y: 0, duration: 0.5, delay: 0.2, onComplete: () => scene.remove(t) });
            }
            
            setTimeout(() => {
                damageEarth(target, 20, 0.35, [0.2, 0, 0.4]); // ×¡×’×•×œ
                createParticles(target, 0xaa00ff, 40);
                shake += 0.3;
            }, 300);
        }

        function createParticles(pos, color, count) {
            const pGeo = new THREE.BufferGeometry();
            const pPos = [];
            const pVel = [];
            
            for(let i=0; i<count; i++) {
                pPos.push(pos.x, pos.y, pos.z);
                const v = new THREE.Vector3(Math.random()-0.5, Math.random()-0.5, Math.random()-0.5).normalize().multiplyScalar(0.05);
                pVel.push(v.x, v.y, v.z);
            }
            
            pGeo.setAttribute('position', new THREE.Float32BufferAttribute(pPos, 3));
            const mat = new THREE.PointsMaterial({ color: color, size: 0.15, transparent: true });
            const points = new THREE.Points(pGeo, mat);
            scene.add(points);

            // ×× ×™××¦×™×” ×¤×©×•×˜×” ×œ×—×œ×§×™×§×™×
            let frame = 0;
            function tick() {
                frame++;
                const arr = pGeo.attributes.position.array;
                for(let i=0; i<count; i++) {
                    arr[i*3] += pVel[i*3];
                    arr[i*3+1] += pVel[i*3+1];
                    arr[i*3+2] += pVel[i*3+2];
                }
                pGeo.attributes.position.needsUpdate = true;
                mat.opacity -= 0.02;
                if (mat.opacity > 0) requestAnimationFrame(tick);
                else scene.remove(points);
            }
            tick();
        }

        // --- ×× ×•×¢ ×”×¨×¡ ---
        function damageEarth(point, dmg, radius, colorRGB) {
            health -= dmg;
            if (health < 0) health = 0;
            
            // ×¢×“×›×•×Ÿ UI
            document.getElementById('health-bar-fill').style.width = health + '%';
            document.getElementById('health-text').innerText = `××¦×‘ ×”×›×•×›×‘: ${Math.round(health)}%`;

            if (health <= 0 && !isGameOver) {
                gameOver();
                return;
            }

            // ×¢×™×•×•×ª ×’×™××•××˜×¨×™×” ×•×¦×‘×¢
            const positions = geometry.attributes.position;
            const colors = geometry.attributes.color;
            const v = new THREE.Vector3();

            for (let i = 0; i < positions.count; i++) {
                v.set(positions.getX(i), positions.getY(i), positions.getZ(i));
                // ×‘×“×™×§×ª ××¨×—×§ (×—×™×™×‘×™× ×œ×”×›×¤×™×œ ×‘××˜×¨×™×¦×” ×× ×”×™×• ×˜×¨× ×¡×¤×•×¨××¦×™×•×ª, ×›××Ÿ ×”×’×œ×•×‘×•×¡ ×‘-0,0,0)
                // ×¢×§×‘ ×¨×•×˜×¦×™×” ×©×œ ×”×’×¨×•×¤, ×”×—×™×©×•×‘ ×”××“×•×™×§ ××•×¨×›×‘ ×™×•×ª×¨, ×œ×›×Ÿ × ×©×ª××© ×‘×§×™×¨×•×‘ ××§×•××™
                // ×”×¤×ª×¨×•×Ÿ ×”×¤×©×•×˜: ×”××¨×ª × ×§×•×“×ª ×”×¤×’×™×¢×” ×œ××¢×¨×›×ª ×”×§×•××•×¨×“×™× ×˜×•×ª ×”××§×•××™×ª ×©×œ ×”×›×“×•×¨
                const localPoint = earth.worldToLocal(point.clone());
                
                const dist = v.distanceTo(localPoint);

                if (dist < radius) {
                    // ×”× ××›×ª ×’×•×‘×” (××›×ª×©)
                    const factor = (radius - dist) / radius;
                    v.lerp(new THREE.Vector3(0,0,0), factor * 0.3); 
                    positions.setXYZ(i, v.x, v.y, v.z);

                    // ×¦×‘×™×¢×”
                    colors.setXYZ(i, colorRGB[0], colorRGB[1], colorRGB[2]);
                }
            }
            positions.needsUpdate = true;
            colors.needsUpdate = true;
            geometry.computeVertexNormals();
        }

        function gameOver() {
            isGameOver = true;
            playSfx('nuke');
            
            // ×©×‘×™×¨×ª ×”×›×“×•×¨ (××¤×§×˜ ×•×™×–×•××œ×™ ××”×™×¨ - ×”×¡×ª×¨×” ×•×”×—×œ×¤×” ×‘×¤×™×¦×•×¥)
            scene.remove(earthGroup);
            scene.remove(atmosphere);
            
            createParticles(new THREE.Vector3(0,0,0), 0xff5500, 500); // ×¤×™×¦×•×¥ ×¡×•×¤×™
            
            setTimeout(() => {
                document.getElementById('ui-container').style.display = 'none';
                document.getElementById('game-over').style.display = 'flex';
            }, 1000);
        }

        window.resetGame = function() {
            location.reload(); // ×”×›×™ × ×§×™ ×•×¤×©×•×˜ ×œ××ª×—×•×œ ××œ× ×©×œ WebGL
        }

        // --- ×œ×•×œ××ª ××©×—×§ ---
        function animate() {
            requestAnimationFrame(animate);

            if (!isGameOver) {
                earthGroup.rotation.y += 0.001;
                clouds.rotation.y += 0.0015;
            }

            // ×¨×¢×™×“×•×ª ××¦×œ××”
            if (shake > 0) {
                camera.position.x = (Math.random() - 0.5) * shake;
                camera.position.y = (Math.random() - 0.5) * shake;
                camera.position.z = 4 + (Math.random() - 0.5) * shake;
                shake *= 0.9;
                if (shake < 0.01) { shake = 0; camera.position.set(0,0,4); }
            }

            renderer.render(scene, camera);
        }

        // ×”×ª×××” ×œ××¡×š
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();

    </script>
</body>
</html>
