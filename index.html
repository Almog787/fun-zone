<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R-Light Pro Enterprise - JSON Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap');
        body { font-family: 'Assistant', sans-serif; background: #f1f5f9; color: #1e293b; overflow: hidden; height: 100vh; }
        
        /* Layout */
        .app-grid { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }
        .sidebar { background: #0f172a; color: white; padding: 20px; display: flex; flex-direction: column; }
        .main-content { overflow-y: auto; padding: 25px; position: relative; }
        
        /* Gantt Component */
        .gantt-card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); overflow: hidden; }
        .gantt-header { display: flex; background: #f8fafc; border-bottom: 2px solid #e2e8f0; }
        .gantt-label-col { width: 160px; flex-shrink: 0; background: #f8fafc; border-left: 2px solid #e2e8f0; padding: 10px; font-weight: 800; position: sticky; right: 0; z-index: 10; }
        .gantt-timeline { flex-grow: 1; position: relative; min-width: 1200px; height: 100%; display: flex; }
        .hour-mark { flex: 1; border-right: 1px solid #f1f5f9; text-align: center; font-size: 10px; color: #94a3b8; padding-top: 5px; }
        
        .gantt-row { display: flex; height: 55px; border-bottom: 1px solid #f1f5f9; position: relative; align-items: center; }
        .task-block {
            position: absolute; height: 70%; top: 15%; border-radius: 6px; font-size: 11px;
            color: white; display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.2s; z-index: 1; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden; padding: 0 4px;
        }
        .task-block:hover { transform: scale(1.03); z-index: 20; filter: brightness(1.1); }
        
        /* Violation Alert */
        .violation { 
            background: #ef4444 !important; 
            border: 2px solid white; 
            animation: pulse 1s infinite; 
            z-index: 30 !important;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Status Colors */
        .bg-insp { background: #2563eb; }
        .bg-travel { background: #f59e0b; }
        .bg-anchor { background: #9333ea; }
        .bg-admin { background: #64748b; }

        /* JSON Editor */
        #json-display { width: 100%; height: calc(100vh - 250px); font-family: monospace; background: #1e293b; color: #38bdf8; padding: 15px; border-radius: 8px; font-size: 12px; resize: none; border: none; outline: none; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>

    <div class="app-grid">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="text-2xl font-black mb-10 flex items-center gap-2 italic">
                <i class="fas fa-microchip text-blue-500"></i> R-LIGHT <span class="text-blue-500 text-sm">PRO</span>
            </div>
            
            <nav class="space-y-3 flex-1">
                <button onclick="switchTab('dashboard')" class="w-full text-right p-3 rounded hover:bg-slate-800 flex items-center gap-3 transition">
                    <i class="fas fa-th-large w-5 text-slate-400"></i> לוח בקרה
                </button>
                <button onclick="switchTab('gantt')" class="w-full text-right p-3 rounded hover:bg-slate-800 flex items-center gap-3 transition">
                    <i class="fas fa-stream w-5 text-slate-400"></i> עריכה וגאנט
                </button>
                <button onclick="switchTab('json')" class="w-full text-right p-3 rounded hover:bg-slate-800 flex items-center gap-3 transition">
                    <i class="fas fa-code w-5 text-slate-400"></i> קובץ JSON
                </button>
            </nav>

            <div class="bg-slate-800 p-4 rounded-xl">
                <div class="text-[10px] uppercase font-bold text-slate-500 mb-2">סטטוס מנוע חוקים</div>
                <div id="validator-status" class="text-sm font-bold text-green-400">
                    <i class="fas fa-check-circle"></i> לו"ז תקין
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            
            <!-- Dashboard Page -->
            <div id="tab-dashboard" class="tab-content active space-y-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-extrabold text-slate-800">דאשבורד ניהול</h1>
                    <div class="flex gap-3">
                        <input type="date" id="start-date" class="border p-2 rounded-lg shadow-sm">
                        <button onclick="runAutomaticScheduler()" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-bold hover:bg-blue-700 transition shadow-lg">
                            <i class="fas fa-magic"></i> יצירת שיבוץ אוטומטי
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border-r-4 border-blue-600">
                        <div class="text-slate-400 font-bold text-sm uppercase">משימות שובצו</div>
                        <div class="text-4xl font-black text-slate-800" id="stat-tasks">0</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border-r-4 border-purple-600">
                        <div class="text-slate-400 font-bold text-sm uppercase">עוגנים פעילים</div>
                        <div class="text-4xl font-black text-slate-800" id="stat-anchors">0</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border-r-4 border-red-600">
                        <div class="text-slate-400 font-bold text-sm uppercase">חריגות (שעות/חפיפה)</div>
                        <div class="text-4xl font-black text-red-600" id="stat-violations">0</div>
                    </div>
                </div>

                <!-- Live Violations Feed -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                    <h3 class="font-bold text-lg mb-4 text-slate-700 underline decoration-red-500 underline-offset-4">פירוט חריגות בזמן אמת</h3>
                    <div id="violation-feed" class="space-y-2 text-sm max-h-40 overflow-y-auto">
                        <p class="text-slate-400 italic italic text-center py-4">אין חריגות במערכת...</p>
                    </div>
                </div>
            </div>

            <!-- Gantt Page -->
            <div id="tab-gantt" class="tab-content space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold italic">עריכת לו"ז דינמית</h2>
                    <div class="flex items-center gap-4">
                        <label class="text-sm font-bold">יום לתצוגה:</label>
                        <select id="gantt-day-select" onchange="renderGantt()" class="border p-2 rounded-lg bg-white shadow-sm font-bold text-blue-600"></select>
                    </div>
                </div>

                <div class="gantt-card">
                    <div class="gantt-header" id="gantt-header-hours">
                        <div class="gantt-label-col">בקר</div>
                        <!-- Hours 06-23 generated here -->
                    </div>
                    <div id="gantt-rows-container"></div>
                </div>
            </div>

            <!-- JSON Editor Page -->
            <div id="tab-json" class="tab-content space-y-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">Database JSON Editor</h2>
                        <p class="text-xs text-slate-500 uppercase font-bold">ערוך את הקובץ ישירות כדי לעדכן את המערכת</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadJSON()" class="bg-slate-700 text-white px-4 py-2 rounded font-bold text-xs hover:bg-slate-800 transition">
                            <i class="fas fa-download"></i> הורד קובץ
                        </button>
                        <button onclick="saveJsonChanges()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold text-xs hover:bg-blue-700 transition">
                            <i class="fas fa-save"></i> שמור שינויים
                        </button>
                    </div>
                </div>
                <textarea id="json-display" spellcheck="false"></textarea>
            </div>

        </main>
    </div>

    <!-- Edit Task Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border border-slate-200">
            <h3 class="text-xl font-bold mb-6 flex justify-between items-center">
                עריכת משימה
                <button onclick="closeModal()" class="text-slate-400 hover:text-red-500 transition text-2xl">×</button>
            </h3>
            <input type="hidden" id="edit-id">
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-1">סוג משימה</label>
                    <select id="edit-type" class="w-full border p-2.5 rounded-xl bg-slate-50 outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="insp">בקרת תחנה</option>
                        <option value="travel">נסיעה</option>
                        <option value="anchor">עוגן</option>
                        <option value="admin">מנהלה/סגירה</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase block mb-1">מיקום</label>
                    <select id="edit-loc" class="w-full border p-2.5 rounded-xl bg-slate-50 outline-none focus:ring-2 focus:ring-blue-500"></select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1">זמן התחלה (HH:MM)</label>
                        <input type="text" id="edit-start" class="w-full border p-2.5 rounded-xl bg-slate-50 text-center font-bold">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase block mb-1">משך (דקות)</label>
                        <input type="number" id="edit-dur" class="w-full border p-2.5 rounded-xl bg-slate-50 text-center font-bold">
                    </div>
                </div>
            </div>
            <div class="mt-8 flex gap-3">
                <button onclick="saveTaskChanges()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition">שמור שינויים</button>
                <button onclick="deleteTask()" class="bg-red-50 text-red-600 px-6 py-3 rounded-xl font-bold hover:bg-red-600 hover:text-white transition border border-red-200">מחק</button>
            </div>
        </div>
    </div>

    <script>
        // --- Core Data Schema (Matches Requirements) ---
        const initialDB = {
            meta: { version: "7.0 Pro", lastSync: null },
            settings: { maxShiftMins: 540, minRestMins: 480 },
            inspectors: [
                {name:"דניאל אברהם", shift:"בוקר", base:"תמ פת"},
                {name:"רונית לוי", shift:"בוקר", base:"הקוממיות"},
                {name:"יוסי כהן", shift:"בוקר", base:"אליפלט"},
                {name:"אלירן סבג", shift:"ערב", base:"תמ פת"},
                {name:"משה אשכנזי", shift:"ערב", base:"ארלוזורוב"},
                {name:"רותם סלע", shift:"ערב", base:"יפו"}
            ],
            stations: [
                {name:"תמ פת", geo:1, target:20}, {name:"אהרונוביץ", geo:9, target:30},
                {name:"בן גוריון", geo:11, target:30}, {name:"אלנבי", geo:18, target:30},
                {name:"קרית אריה", geo:4, target:25}, {name:"הקוממיות", geo:34, target:25}
            ],
            schedule: [], 
            anchors: []
        };

        let db = JSON.parse(JSON.stringify(initialDB));
        const days = ["ראשון","שני","שלישי","רביעי","חמישי","שישי","שבת"];

        // --- System Initialization ---
        window.onload = () => {
            const saved = localStorage.getItem('rlight_v7_db');
            if(saved) db = JSON.parse(saved);
            
            // Populate Selects
            document.getElementById('gantt-day-select').innerHTML = days.map((d,i) => `<option value="${i}">${d}</option>`).join('');
            document.getElementById('edit-loc').innerHTML = [...db.stations.map(s=>`<option>${s.name}</option>`), '<option>משרד</option>', '<option>קצה</option>'].join('');
            document.getElementById('start-date').value = new Date().toISOString().split('T')[0];

            syncSystem();
        };

        // --- Core Sync Logic ---
        function syncSystem() {
            db.meta.lastSync = new Date().toISOString();
            localStorage.setItem('rlight_v7_db', JSON.stringify(db));
            
            // Sync Text Editor
            document.getElementById('json-display').value = JSON.stringify(db, null, 2);
            
            // Validate Logic
            const violations = validateSchedule();
            
            // Update Dashboard
            document.getElementById('stat-tasks').innerText = db.schedule.length;
            document.getElementById('stat-anchors').innerText = db.anchors.length;
            document.getElementById('stat-violations').innerText = violations.length;
            
            renderViolationsList(violations);
            
            // If Gantt is active, refresh it
            if(document.getElementById('tab-gantt').classList.contains('active')) renderGantt(violations);
            
            // Validator Status
            const statusEl = document.getElementById('validator-status');
            if(violations.length > 0) {
                statusEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> נמצאו ${violations.length} חריגות`;
                statusEl.className = "text-sm font-bold text-red-500";
            } else {
                statusEl.innerHTML = `<i class="fas fa-check-circle"></i> לו"ז תקין`;
                statusEl.className = "text-sm font-bold text-green-400";
            }
        }

        // --- Rule Engine (Validation) ---
        function validateSchedule() {
            const violations = [];
            
            db.inspectors.forEach(insp => {
                for(let d=0; d<7; d++) {
                    const tasks = db.schedule.filter(t => t.inspector === insp.name && t.dayIdx === d).sort((a,b) => a.start - b.start);
                    if(tasks.length === 0) continue;

                    // Rule 1: Max Shift Duration (9 Hours)
                    const shiftStart = tasks[0].start;
                    const shiftEnd = tasks[tasks.length - 1].end;
                    if((shiftEnd - shiftStart) > db.settings.maxShiftMins) {
                        violations.push({
                            type: 'shift_length',
                            msg: `${insp.name} (יום ${days[d]}): משמרת מעל 9 שעות`,
                            taskIds: tasks.map(t=>t.id)
                        });
                    }

                    // Rule 2: Overlaps
                    for(let i=0; i < tasks.length - 1; i++) {
                        if(tasks[i].end > tasks[i+1].start) {
                            violations.push({
                                type: 'overlap',
                                msg: `${insp.name} (יום ${days[d]}): חפיפה בין משימות בשעה ${minsToTime(tasks[i+1].start)}`,
                                taskIds: [tasks[i].id, tasks[i+1].id]
                            });
                        }
                    }
                }
            });
            return violations;
        }

        // --- UI Rendering ---
        function renderGantt(violations = []) {
            const dayIdx = parseInt(document.getElementById('gantt-day-select').value);
            const header = document.getElementById('gantt-header-hours');
            const container = document.getElementById('gantt-rows-container');
            
            // Render Header
            let headerHTML = `<div class="gantt-label-col">בקר / שעה</div><div class="gantt-timeline">`;
            for(let h=6; h<=23; h++) headerHTML += `<div class="hour-mark">${h}:00</div>`;
            header.innerHTML = headerHTML + `</div>`;

            // Render Rows
            const pxPerMin = 1200 / (18 * 60); // min-width / 18 hours

            container.innerHTML = db.inspectors.map(insp => {
                const inspTasks = db.schedule.filter(t => t.inspector === insp.name && t.dayIdx === dayIdx);
                
                return `
                    <div class="gantt-row">
                        <div class="gantt-label-col text-slate-700">${insp.name}</div>
                        <div class="gantt-timeline">
                            ${inspTasks.map(t => {
                                const left = (t.start - 360) * pxPerMin;
                                const width = (t.end - t.start) * pxPerMin;
                                const isViolated = violations.some(v => v.taskIds.includes(t.id));
                                
                                return `
                                    <div class="task-block bg-${t.type} ${isViolated ? 'violation' : ''}" 
                                         style="left: ${left}px; width: ${width}px;"
                                         onclick="openEditModal('${t.id}')">
                                        <span class="font-bold truncate w-full px-1">${t.location}</span>
                                        <span class="text-[9px] opacity-80">${minsToTime(t.start)}-${minsToTime(t.end)}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderViolationsList(violations) {
            const feed = document.getElementById('violation-feed');
            if(violations.length === 0) {
                feed.innerHTML = `<p class="text-green-500 font-bold italic text-center py-4">✓ אין חריגות במערכת</p>`;
                return;
            }
            feed.innerHTML = violations.map(v => `
                <div class="bg-red-50 border-r-4 border-red-500 p-2 rounded flex justify-between items-center">
                    <span class="font-bold text-red-700"><i class="fas fa-exclamation-circle"></i> ${v.msg}</span>
                </div>
            `).join('');
        }

        // --- Task Automatic Generation (Engine) ---
        function runAutomaticScheduler() {
            db.schedule = [];
            const dateStr = document.getElementById('start-date').value;

            for(let d=0; d<7; d++) {
                db.inspectors.forEach(insp => {
                    let time = insp.shift === "בוקר" ? 360 : 840;
                    const shiftEnd = insp.shift === "בוקר" ? 870 : 1350;
                    let loc = insp.base;

                    while(time < shiftEnd - 60) {
                        // Find best station logic
                        let next = db.stations[Math.floor(Math.random() * db.stations.length)];
                        let travel = Math.abs(next.geo - (db.stations.find(s=>s.name===loc)?.geo || 1)) * 4 + 5;
                        
                        if(travel > 5) {
                            addTask(d, dateStr, insp.name, "נסיעה", next.name, time, travel, "travel");
                            time += travel;
                        }

                        addTask(d, dateStr, insp.name, "בקרת תחנה", next.name, time, 30, "insp");
                        time += 30;
                        loc = next.name;
                    }
                    addTask(d, dateStr, insp.name, "סגירה", "משרד", time, (shiftEnd - time), "admin");
                });
            }
            syncSystem();
            switchTab('gantt');
        }

        function addTask(dayIdx, date, inspector, taskName, location, start, duration, type) {
            db.schedule.push({
                id: "T-" + Math.random().toString(36).substr(2, 9),
                dayIdx, date, inspector, taskName, location,
                start, end: start + duration, type
            });
        }

        // --- Modal & Editing Logic ---
        function openEditModal(taskId) {
            const task = db.schedule.find(t => t.id === taskId);
            if(!task) return;
            
            document.getElementById('edit-id').value = taskId;
            document.getElementById('edit-type').value = task.type;
            document.getElementById('edit-loc').value = task.location;
            document.getElementById('edit-start').value = minsToTime(task.start);
            document.getElementById('edit-dur').value = (task.end - task.start);
            
            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-modal').classList.add('flex');
        }

        function saveTaskChanges() {
            const id = document.getElementById('edit-id').value;
            const task = db.schedule.find(t => t.id === id);
            
            if(task) {
                task.type = document.getElementById('edit-type').value;
                task.location = document.getElementById('edit-loc').value;
                task.start = timeToMins(document.getElementById('edit-start').value);
                task.end = task.start + parseInt(document.getElementById('edit-dur').value);
                
                syncSystem();
                closeModal();
            }
        }

        function deleteTask() {
            const id = document.getElementById('edit-id').value;
            db.schedule = db.schedule.filter(t => t.id !== id);
            syncSystem();
            closeModal();
        }

        function saveJsonChanges() {
            try {
                const newDB = JSON.parse(document.getElementById('json-display').value);
                db = newDB;
                syncSystem();
                alert("קובץ עודכן בהצלחה!");
            } catch(e) {
                alert("שגיאה בפורמט ה-JSON. נא לבדוק את הקוד.");
            }
        }

        // --- Helpers ---
        function minsToTime(m) {
            let h = Math.floor(m / 60);
            let mins = m % 60;
            return `${h.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        function timeToMins(t) {
            let [h, m] = t.split(':').map(Number);
            return h * 60 + m;
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.add('active');
            if(id === 'gantt') renderGantt(validateSchedule());
        }

        function closeModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            document.getElementById('edit-modal').classList.remove('flex');
        }

        function downloadJSON() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db, null, 2));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", "rail_pro_db.json");
            dlAnchorElem.click();
        }
    </script>
</body>
</html>
