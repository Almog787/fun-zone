<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>לוח טיסות נתב"ג - זמן אמת</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700;800&display=swap');
        body { font-family: 'Assistant', sans-serif; background-color: #0f172a; color: white; }
        .flight-row:nth-child(even) { background-color: rgba(255, 255, 255, 0.05); }
        .status-landed { color: #4ade80; } /* ירוק */
        .status-delayed { color: #f87171; } /* אדום */
        .status-final { color: #60a5fa; } /* כחול */
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-4xl font-black tracking-tighter text-blue-400 italic">TLV LIVE <span class="text-white">BOARD</span></h1>
                <p class="text-slate-400 text-sm">נתונים רשמיים מרשות שדות התעופה (data.gov.il)</p>
            </div>
            
            <div class="flex bg-slate-800 p-1 rounded-xl shadow-inner">
                <button onclick="changeMode('D')" id="btn-dep" class="px-6 py-2 rounded-lg font-bold transition bg-blue-600">המראות</button>
                <button onclick="changeMode('A')" id="btn-arr" class="px-6 py-2 rounded-lg font-bold transition">נחיתות</button>
            </div>
        </header>

        <!-- Search & Filter -->
        <div class="mb-6 relative">
            <input type="text" id="search" placeholder="חפש עיר, חברה או מספר טיסה..." 
                class="w-full bg-slate-800 border border-slate-700 p-4 rounded-2xl outline-none focus:border-blue-500 transition shadow-lg text-lg">
            <div id="loading" class="absolute left-4 top-4 hidden">
                <div class="animate-spin rounded-full h-6 w-6 border-2 border-blue-500 border-t-transparent"></div>
            </div>
        </div>

        <!-- Table Container -->
        <div class="bg-slate-900 rounded-3xl overflow-hidden shadow-2xl border border-slate-800">
            <div class="overflow-x-auto">
                <table class="w-full text-right border-collapse">
                    <thead>
                        <tr class="bg-slate-800 text-slate-400 uppercase text-xs font-bold tracking-widest">
                            <th class="p-4">חברה</th>
                            <th class="p-4">טיסה</th>
                            <th class="p-4">יעד/מקור</th>
                            <th class="p-4 text-center">טרמינל</th>
                            <th class="p-4">זמן מתוכנן</th>
                            <th class="p-4">סטטוס</th>
                        </tr>
                    </thead>
                    <tbody id="flight-table" class="divide-y divide-slate-800">
                        <!-- נתונים יוזרקו כאן -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="no-results" class="hidden text-center py-20 text-slate-500 italic">לא נמצאו טיסות תואמות</div>
    </div>

    <script>
        // מזהה המשאיר של לוח הטיסות ב-data.gov.il
        const RESOURCE_ID = "e83f7610-d348-4030-af11-b91817454942";
        const API_URL = "https://data.gov.il/api/3/action/datastore_search";
        
        let currentMode = 'D'; // D = Departures, A = Arrivals
        let allFlights = [];

        async function fetchFlights() {
            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');

            try {
                // אנחנו מושכים את 200 הטיסות האחרונות (המראות ונחיתות יחד)
                const response = await fetch(`${API_URL}?resource_id=${RESOURCE_ID}&limit=250`);
                const data = await response.json();
                allFlights = data.result.records;
                
                renderTable();
            } catch (error) {
                console.error("API Error:", error);
                alert("שגיאה בחיבור לפורטל הנתונים הממשלתי");
            } finally {
                loading.classList.add('hidden');
            }
        }

        function renderTable() {
            const tableBody = document.getElementById('flight-table');
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const noResults = document.getElementById('no-results');
            
            // סינון לפי מצב (המראה/נחיתה) ולפי חיפוש
            const filtered = allFlights.filter(f => {
                const matchesMode = f.CHRMINE.includes(currentMode === 'D' ? 'DEPARTED' : 'LANDED') || 
                                    f.CHRMINE.includes(currentMode === 'D' ? 'ON TIME' : 'FINAL') ||
                                    (currentMode === 'D' && f.CHRMINE === "") || // חלק מהמראות ללא סטטוס
                                    f.CHRMINE.includes(currentMode === 'D' ? 'המריאה' : 'נחתה');
                
                // בגלל שהדאטה של הממשלה קצת "מלוכלך", נסנן לפי שדה ה-CHRMINE (סטטוס)
                const isDeparture = f.CHRMINE.includes("DEPARTED") || f.CHRMINE.includes("המריאה") || f.CHRMINE.includes("CHECK-IN");
                const isArrival = f.CHRMINE.includes("LANDED") || f.CHRMINE.includes("נחתה") || f.CHRMINE.includes("FINAL");
                
                const modeFilter = (currentMode === 'D' ? isDeparture : isArrival);

                const searchStr = `${f.CHOPER} ${f.CHFLTN} ${f.CHLOC1CH}`.toLowerCase();
                return modeFilter && searchStr.includes(searchTerm);
            });

            tableBody.innerHTML = filtered.map(f => {
                const time = f.CHSTOL.split('T')[1].substring(0, 5); // פורמט HH:MM
                const status = f.CHRMINE || "בזמן";
                
                let statusClass = "";
                if(status.includes("LANDED") || status.includes("DEPARTED")) statusClass = "status-landed";
                if(status.includes("CANCELLED") || status.includes("DELAYED")) statusClass = "status-delayed";
                if(status.includes("FINAL")) statusClass = "status-final";

                return `
                    <tr class="flight-row hover:bg-slate-800/50 transition duration-150">
                        <td class="p-4 font-bold">${f.CHOPER}</td>
                        <td class="p-4 text-blue-400 font-mono">${f.CHFLTN}</td>
                        <td class="p-4 text-lg font-medium">${f.CHLOC1CH}</td>
                        <td class="p-4 text-center font-bold text-slate-500">${f.CHTERM}</td>
                        <td class="p-4 font-mono text-slate-300">${time}</td>
                        <td class="p-4 font-bold text-sm ${statusClass}">${status}</td>
                    </tr>
                `;
            }).join('');

            noResults.classList.toggle('hidden', filtered.length > 0);
        }

        function changeMode(mode) {
            currentMode = mode;
            document.getElementById('btn-dep').classList.toggle('bg-blue-600', mode === 'D');
            document.getElementById('btn-arr').classList.toggle('bg-blue-600', mode === 'A');
            renderTable();
        }

        // האזנה לחיפוש
        document.getElementById('search').addEventListener('input', renderTable);

        // הפעלה ורענון אוטומטי כל דקה
        fetchFlights();
        setInterval(fetchFlights, 60000);
    </script>
</body>
</html>
