<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMERGENCY RADAR 3D | Global Tactical Suite</title>
    
    <!-- Tailwind & FontAwesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- CesiumJS for 3D Globe -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Orbitron:wght@400;900&display=swap');
        
        body {
            background-color: #000;
            color: #00ff41;
            font-family: 'JetBrains Mono', monospace;
            overflow: hidden;
            height: 100vh;
            margin: 0;
        }

        /* HUD & UI Layers */
        #cesiumContainer {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1;
        }

        .hud-layer {
            position: absolute; inset: 0; pointer-events: none; z-index: 10;
            display: flex; flex-direction: column;
        }

        .interactive { pointer-events: auto; }

        .panel-glass {
            background: rgba(5, 10, 5, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 255, 65, 0.2);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
        }

        .cinema-hidden { display: none !important; }

        /* Scanning Line Effect */
        .radar-scan {
            width: 100%; height: 2px; background: rgba(0, 255, 65, 0.2);
            position: absolute; z-index: 100; pointer-events: none;
            animation: scan 6s linear infinite;
        }
        @keyframes scan { from { top: 0; } to { top: 100%; } }

        /* Red pulse for emergency */
        .emergency-glow {
            animation: glow-red 1s infinite alternate;
        }
        @keyframes glow-red {
            from { text-shadow: 0 0 5px #ff0000; color: #ff4444; }
            to { text-shadow: 0 0 20px #ff0000; color: #ff0000; }
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }
    </style>
</head>
<body>

    <!-- 3D Globe Container -->
    <div id="cesiumContainer"></div>

    <!-- UI Overlay -->
    <div class="hud-layer">
        <div class="radar-scan"></div>

        <!-- Top Navigation -->
        <header id="main-header" class="h-16 panel-glass flex justify-between items-center px-6 border-b border-green-900/30">
            <div class="flex items-center gap-4">
                <i class="fas fa-crosshairs text-red-600 animate-pulse text-xl"></i>
                <div>
                    <h1 class="orbitron text-lg font-black tracking-widest text-white">TACTICAL_RADAR <span class="text-green-500">3D</span></h1>
                    <p class="text-[8px] uppercase tracking-[0.4em] opacity-60">Global Emergency Intercept System</p>
                </div>
            </div>

            <div class="flex items-center gap-6 interactive">
                <div class="flex items-center gap-4 text-[10px] font-bold mr-4 border-r border-green-900/30 pr-6">
                    <button onclick="toggleAudio()" id="audio-toggle" class="hover:text-white transition">
                        <i class="fas fa-volume-up mr-1"></i> AUDIO: ON
                    </button>
                    <button onclick="toggleCinema()" class="hover:text-white transition">
                        <i class="fas fa-expand mr-1"></i> CINEMA MODE
                    </button>
                </div>
                <div id="clock" class="orbitron text-lg font-bold text-green-400">00:00:00</div>
            </div>
        </header>

        <!-- Main Workspace -->
        <div class="flex-1 flex overflow-hidden">
            
            <!-- Sidebar: Crisis Log -->
            <aside id="main-sidebar" class="w-80 panel-glass m-4 rounded-2xl border border-green-900/30 flex flex-col interactive overflow-hidden">
                <div class="p-4 border-b border-green-900/30 bg-green-900/5 flex justify-between items-center">
                    <span class="text-xs font-black uppercase tracking-widest">System_Log</span>
                    <span class="text-[8px] bg-red-600 text-white px-1 rounded animate-pulse">LIVE_STREAM</span>
                </div>
                
                <div id="event-feed" class="flex-1 overflow-y-auto p-4 space-y-4 text-[10px] scroll-smooth">
                    <div class="opacity-40 italic">> Establishing satellite link...</div>
                    <div class="opacity-40 italic">> 3D Map tiles loaded.</div>
                </div>

                <div class="p-4 bg-black/40 text-[9px] border-t border-green-900/30">
                    <div class="flex justify-between mb-1">
                        <span>AIRCRAFT_UNITS:</span>
                        <span id="stat-planes" class="text-white">SCANNING</span>
                    </div>
                    <div class="flex justify-between">
                        <span>SEISMIC_GEO:</span>
                        <span id="stat-seismic" class="text-white">MONITORING</span>
                    </div>
                </div>
            </aside>

            <!-- Bottom Floating HUD -->
            <div id="bottom-hud" class="absolute bottom-6 left-1/2 -translate-x-1/2 panel-glass p-4 rounded-full flex gap-10 px-12 border-green-500/20 interactive">
                <div class="text-center">
                    <div class="text-[8px] opacity-60 uppercase">Active Emergencies</div>
                    <div id="count-7700" class="text-xl font-black orbitron text-red-500">0</div>
                </div>
                <div class="text-center border-x border-green-900/30 px-10">
                    <div class="text-[8px] opacity-60 uppercase">Sensor Accuracy</div>
                    <div class="text-xl font-black orbitron text-green-400">99.4%</div>
                </div>
                <div class="text-center">
                    <div class="text-[8px] opacity-60 uppercase">Global Density</div>
                    <div id="density-val" class="text-xl font-black orbitron text-blue-400">MED</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- System Configuration ---
        const viewer = new Cesium.Viewer('cesiumContainer', {
            terrainProvider: Cesium.createWorldTerrain(),
            baseLayerPicker: false,
            geocoder: false,
            homeButton: false,
            infoBox: false,
            sceneModePicker: true,
            selectionIndicator: false,
            timeline: false,
            animation: false,
            navigationHelpButton: false,
            scene3DOnly: true
        });

        // Use a dark map style
        viewer.imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({
            url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
        }));

        let audioEnabled = true;
        let cinemaMode = false;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // --- Synthetic Audio Engine ---
        function playRadarPing() {
            if (!audioEnabled) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        function playRadioStatic() {
            if (!audioEnabled) return;
            const bufferSize = audioCtx.sampleRate * 0.2;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const output = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) output[i] = Math.random() * 2 - 1;
            const whiteNoise = audioCtx.createBufferSource();
            whiteNoise.buffer = buffer;
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.2);
            whiteNoise.connect(gain);
            gain.connect(audioCtx.destination);
            whiteNoise.start();
        }

        // --- Data Fetching ---
        async function updateEmergencyData() {
            try {
                // 1. Fetch Aircraft (OpenSky)
                const planeRes = await fetch('https://opensky-network.org/api/states/all');
                const planeData = await planeRes.json();
                const emergencies = planeData.states.filter(s => s[14] === "7700");
                
                document.getElementById('stat-planes').innerText = planeData.states.length + " UNITS";
                document.getElementById('count-7700').innerText = emergencies.length;
                
                if (emergencies.length > 0) {
                    playRadarPing();
                    emergencies.forEach(p => renderPlane(p, true));
                }

                // 2. Fetch Earthquakes (USGS)
                const quakeRes = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/4.5_day.geojson');
                const quakeData = await quakeRes.json();
                document.getElementById('stat-seismic').innerText = quakeData.features.length + " EVENTS";
                quakeData.features.slice(0, 10).forEach(renderQuake);

                // Update density
                const density = planeData.states.length > 5000 ? "CRITICAL" : "NORMAL";
                document.getElementById('density-val').innerText = density;

            } catch (e) {
                console.error("Data Intercept Error");
            }
        }

        // --- 3D Rendering Helpers ---
        function renderPlane(p, isEmergency) {
            const id = p[0];
            const lat = p[6];
            const lon = p[5];
            const alt = p[7] || 10000;

            viewer.entities.add({
                id: id,
                position: Cesium.Cartesian3.fromDegrees(lon, lat, alt),
                point: {
                    pixelSize: isEmergency ? 12 : 6,
                    color: isEmergency ? Cesium.Color.RED : Cesium.Color.LIME,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 2
                },
                label: {
                    text: p[1] || 'UNK',
                    font: '10px JetBrains Mono',
                    fillColor: Cesium.Color.WHITE,
                    pixelOffset: new Cesium.Cartesian2(0, -15),
                    distanceDisplayCondition: new Cesium.DistanceDisplayCondition(0, 1000000)
                }
            });

            if (isEmergency) {
                addLog(`CRITICAL: Flight ${p[1]} squawking 7700 at ${alt}m`, 'red');
            }
        }

        function renderQuake(q) {
            const coords = q.geometry.coordinates;
            const mag = q.properties.mag;
            
            viewer.entities.add({
                position: Cesium.Cartesian3.fromDegrees(coords[0], coords[1], 0),
                ellipse: {
                    semiMinorAxis: mag * 50000,
                    semiMajorAxis: mag * 50000,
                    material: Cesium.Color.ORANGE.withAlpha(0.3),
                    outline: true,
                    outlineColor: Cesium.Color.ORANGE
                }
            });
        }

        // --- UI Interactions ---
        function addLog(msg, color = 'green') {
            const feed = document.getElementById('event-feed');
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `p-2 border-l-2 ${color === 'red' ? 'border-red-600 bg-red-900/10 emergency-glow' : 'border-green-600 bg-green-900/5'} mb-2`;
            div.innerHTML = `<div>[${time}]</div><div>> ${msg}</div>`;
            feed.prepend(div);
        }

        function toggleAudio() {
            audioEnabled = !audioEnabled;
            document.getElementById('audio-toggle').innerHTML = audioEnabled ? '<i class="fas fa-volume-up"></i> AUDIO: ON' : '<i class="fas fa-volume-mute"></i> AUDIO: OFF';
            if (audioEnabled) audioCtx.resume();
        }

        function toggleCinema() {
            cinemaMode = !cinemaMode;
            document.getElementById('main-header').classList.toggle('cinema-hidden');
            document.getElementById('main-sidebar').classList.toggle('cinema-hidden');
            document.getElementById('bottom-hud').classList.toggle('cinema-hidden');
        }

        // Handle Clicks on Globe
        const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        handler.setInputAction((click) => {
            const pickedObject = viewer.scene.pick(click.position);
            if (Cesium.defined(pickedObject)) {
                playRadioStatic();
                addLog(`INTERCEPTED SIGNAL: ${pickedObject.id.id || 'Unit Data Verified'}`);
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

        // --- App Loop ---
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toTimeString().split(' ')[0];
        }, 1000);

        updateEmergencyData();
        setInterval(updateEmergencyData, 60000);
        
        // Final Viewport fix
        window.addEventListener('resize', () => { viewer.resize(); });
    </script>
</body>
</html>
