<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Panorama Room Builder 3.0</title>
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.15);
            --glass-heavy: rgba(0, 0, 0, 0.7);
            --accent: #00d2ff;
        }

        body { 
            margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: #000; color: white; touch-action: none;
        }

        /* 砖拽 砖转砖 - 注爪 转 */
        #ui-panel {
            position: absolute; top: 15px; right: 15px;
            width: 280px; max-width: calc(100vw - 30px);
            background: var(--glass-heavy);
            backdrop-filter: blur(15px);
            padding: 20px; border-radius: 20px;
            border: 1px solid var(--glass);
            z-index: 100; transition: transform 0.3s ease;
        }

        h2 { margin: 0 0 15px 0; font-size: 18px; color: var(--accent); text-align: center; }

        .control-group { margin-bottom: 15px; }
        label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; color: #ccc; }
        
        input[type="range"] {
            width: 100%; height: 6px; border-radius: 5px;
            background: #444; outline: none; -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px;
            background: var(--accent); border-radius: 50%; cursor: pointer;
        }

        .btn-main {
            background: var(--accent); color: black; border: none;
            padding: 12px; width: 100%; border-radius: 12px;
            font-weight: bold; cursor: pointer; font-size: 14px; margin-top: 10px;
        }

        #upload-btn {
            background: #2ecc71; margin-bottom: 10px;
        }

        #instructions {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--glass-heavy); padding: 8px 20px; border-radius: 30px;
            font-size: 12px; pointer-events: none; white-space: nowrap;
        }

        /* 驻转专  爪爪 转驻专 */
        #toggle-ui {
            position: absolute; top: 15px; left: 15px;
            background: var(--glass-heavy); border: 1px solid var(--glass);
            color: white; padding: 10px; border-radius: 50%; width: 45px; height: 45px;
            cursor: pointer; z-index: 101; display: flex; align-items: center; justify-content: center;
        }

        input[type="file"] { display: none; }
    </style>
</head>
<body>

<button id="toggle-ui">锔</button>

<div id="ui-panel">
    <h2>转 专 转转-</h2>
    
    <label for="imageInput" class="btn-main" id="upload-btn" style="display:block; text-align:center;">
         注 驻专 专
    </label>
    <input type="file" id="imageInput" accept="image/*">

    <div class="control-group">
        <label>专 专: <span id="valW">10</span>m</label>
        <input type="range" id="width" min="2" max="25" step="0.1" value="10">
    </div>

    <div class="control-group">
        <label> 专: <span id="valH">3</span>m</label>
        <input type="range" id="height" min="2" max="8" step="0.1" value="3">
    </div>

    <div class="control-group">
        <label>注拽 专: <span id="valD">10</span>m</label>
        <input type="range" id="depth" min="2" max="25" step="0.1" value="10">
    </div>

    <div class="control-group">
        <label>转拽 注砖 (FOV)</label>
        <input type="range" id="fov" min="40" max="100" value="75">
    </div>

    <button class="btn-main" onclick="toggleLock()"> 爪  / 住</button>
</div>

<div id="instructions">专专  住转 | WASD  爪 转注</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

    let scene, camera, renderer, controls, room;
    let isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    
    // 砖转 转注
    let moveFwd = false, moveBwd = false, moveL = false, moveR = false;
    let touchX = 0, touchY = 0;
    const velocity = new THREE.Vector3();

    init();

    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.6, 0.1); // 拽  注

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        controls = new PointerLockControls(camera, document.body);

        // 爪专转 专 专砖
        updateRoom(10, 3, 10);
        
        setupEventListeners();
        animate();
    }

    function updateRoom(w, h, d) {
        if (room) scene.remove(room);

        const geometry = new THREE.BoxGeometry(w, h, d);
        
        // Shader  拽专转 驻专 - 注 注转 驻转 专
        const material = new THREE.ShaderMaterial({
            uniforms: {
                tex: { value: window.currentTex || new THREE.Texture() }
            },
            vertexShader: `
                varying vec3 vPos;
                void main() {
                    vPos = position;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,
            fragmentShader: `
                uniform sampler2D tex;
                varying vec3 vPos;
                const float PI = 3.14159265359;
                void main() {
                    vec3 dir = normalize(vPos);
                    float u = atan(dir.z, dir.x) / (2.0 * PI) + 0.5;
                    float v = acos(dir.y) / PI;
                    gl_FragColor = texture2D(tex, vec2(u, v));
                }
            `,
            side: THREE.BackSide
        });

        room = new THREE.Mesh(geometry, material);
        scene.add(room);
    }

    function setupEventListeners() {
        // 转  - 专专 
        if (isMobile) {
            document.addEventListener('touchstart', e => {
                touchX = e.touches[0].pageX;
                touchY = e.touches[0].pageY;
            });
            document.addEventListener('touchmove', e => {
                const dx = e.touches[0].pageX - touchX;
                const dy = e.touches[0].pageY - touchY;
                touchX = e.touches[0].pageX;
                touchY = e.touches[0].pageY;

                camera.rotation.y -= dx * 0.005;
                camera.rotation.x -= dy * 0.005;
            });
        }

        // 拽转 (砖)
        const onKey = (val) => (e) => {
            if (e.code === 'KeyW' || e.code === 'ArrowUp') moveFwd = val;
            if (e.code === 'KeyS' || e.code === 'ArrowDown') moveBwd = val;
            if (e.code === 'KeyA' || e.code === 'ArrowLeft') moveL = val;
            if (e.code === 'KeyD' || e.code === 'ArrowRight') moveR = val;
        };
        document.addEventListener('keydown', onKey(true));
        document.addEventListener('keyup', onKey(false));

        // 砖拽 砖转砖
        document.getElementById('imageInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            new THREE.TextureLoader().load(url, (t) => {
                window.currentTex = t;
                room.material.uniforms.tex.value = t;
            });
        });

        const syncRoom = () => {
            const w = document.getElementById('width').value;
            const h = document.getElementById('height').value;
            const d = document.getElementById('depth').value;
            document.getElementById('valW').innerText = w;
            document.getElementById('valH').innerText = h;
            document.getElementById('valD').innerText = d;
            updateRoom(w, h, d);
        };

        ['width', 'height', 'depth'].forEach(id => document.getElementById(id).addEventListener('input', syncRoom));
        
        document.getElementById('fov').addEventListener('input', (e) => {
            camera.fov = e.target.value;
            camera.updateProjectionMatrix();
        });

        document.getElementById('toggle-ui').onclick = () => {
            const panel = document.getElementById('ui-panel');
            panel.style.transform = panel.style.transform === 'translateX(350px)' ? 'translateX(0)' : 'translateX(350px)';
        };

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    }

    window.toggleLock = function() {
        if (!isMobile) controls.lock();
        else alert(": 砖转砖 爪注 住 ");
    };

    function animate() {
        requestAnimationFrame(animate);

        if (controls.isLocked || isMobile) {
            const speed = 0.08;
            if (moveFwd) controls.moveForward(speed);
            if (moveBwd) controls.moveForward(-speed);
            if (moveL) controls.moveRight(-speed);
            if (moveR) controls.moveRight(speed);

            // 住转 爪 拽专转
            const w = document.getElementById('width').value / 2 - 0.5;
            const d = document.getElementById('depth').value / 2 - 0.5;
            camera.position.x = Math.max(-w, Math.min(w, camera.position.x));
            camera.position.z = Math.max(-d, Math.min(d, camera.position.z));
        }

        renderer.render(scene, camera);
    }
</script>
</body>
</html>
