<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RedLine Precision - תכנון משימות מדויק</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap');
        
        body { font-family: 'Assistant', sans-serif; background-color: #f8fafc; }
        
        .task-block { 
            height: 100%; display: flex; flex-direction: column; justify-content: center; 
            padding: 0 6px; font-size: 10px; border-right: 1px solid rgba(255,255,255,0.2);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            transition: transform 0.2s; cursor: help;
        }
        .task-block:hover { transform: scale(1.05); z-index: 20; box-shadow: 0 4px 10px rgba(0,0,0,0.15); border: 1px solid white; }

        /* צבעים לפי סוג משימה */
        .bg-station { background: #059669; color: white; } /* ירוק כהה */
        .bg-station-light { background: #34d399; color: #064e3b; } /* ירוק בהיר */
        .bg-track { background: #d97706; color: white; } /* כתום */
        .bg-track-long { background: #92400e; color: white; } /* חום */
        .bg-onboard { background: #2563eb; color: white; } /* כחול */
        .bg-karon { background: #7c3aed; color: white; } /* סגול */
        .bg-service { background: #db2777; color: white; } /* ורוד */
        .bg-break { background: #e2e8f0; color: #64748b; background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, #cbd5e1 5px, #cbd5e1 10px); }

        .timeline-row { display: flex; align-items: center; border-bottom: 1px solid #e2e8f0; height: 50px; }
        .timeline-tracks { flex: 1; display: flex; height: 36px; background: #f1f5f9; border-radius: 4px; overflow: hidden; position: relative; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b px-6 py-3 flex justify-between items-center z-30 shadow-sm">
        <div>
            <h1 class="font-bold text-lg text-slate-800"><i class="fa-solid fa-list-check text-blue-600"></i> סידור עבודה יומי - אכיפת חוקים מלאה</h1>
            <p class="text-xs text-slate-500">
                <span class="ml-3"><i class="fa-solid fa-check text-green-500"></i> מקס' 1 בקרה לתחנה/יום</span>
                <span class="ml-3"><i class="fa-solid fa-check text-green-500"></i> 4 שעות קרונות בתחנות קצה</span>
                <span><i class="fa-solid fa-check text-green-500"></i> שירות לנוסע ומסלול מלא</span>
            </p>
        </div>
        <button onclick="runScheduler()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-bold shadow text-sm transition">
            <i class="fa-solid fa-rotate"></i> הרץ שיבוץ מחדש
        </button>
    </header>

    <!-- KPI Dashboard -->
    <div class="grid grid-cols-6 gap-0 bg-slate-50 border-b text-center py-2 text-xs divide-x divide-x-reverse divide-slate-200">
        <div class="px-2">
            <div class="text-slate-500">תחנות (יעד: 34)</div>
            <div id="kpiStations" class="font-bold text-lg text-green-600">0/34</div>
        </div>
        <div class="px-2">
            <div class="text-slate-500">מסילות (מקטעים)</div>
            <div id="kpiTracks" class="font-bold text-lg text-orange-600">0</div>
        </div>
        <div class="px-2">
            <div class="text-slate-500">מסלול מלא (80/45)</div>
            <div id="kpiLongTracks" class="font-bold text-lg text-amber-700">0</div>
        </div>
        <div class="px-2">
            <div class="text-slate-500">אונבורד</div>
            <div id="kpiOnboard" class="font-bold text-lg text-blue-600">0</div>
        </div>
        <div class="px-2">
            <div class="text-slate-500">קרונות (שעות)</div>
            <div id="kpiKaron" class="font-bold text-lg text-purple-600">0</div>
        </div>
        <div class="px-2">
            <div class="text-slate-500">שירות לנוסע</div>
            <div id="kpiService" class="font-bold text-lg text-pink-600">0</div>
        </div>
    </div>

    <!-- Timeline Container -->
    <main class="flex-1 overflow-auto p-4">
        <div class="bg-white rounded-lg shadow border border-slate-200 min-w-[1000px]">
            <!-- Hours Header -->
            <div class="flex pl-48 border-b text-[10px] text-slate-400 py-1 sticky top-0 bg-white z-20" id="timeRuler">
                <!-- JS will fill this -->
            </div>
            
            <div id="scheduleContainer"></div>
        </div>
    </main>

    <script>
        // --- 1. Database of Constraints ---

        // תחנות וסיווגן
        const STATIONS = {
            UG: ["אלנבי", "קרליבך", "יהודית", "שאול המלך", "ארלוזורוב", "אבא הלל", "ביאליק", "בן גוריון", "אהרונוביץ", "אם המושבות", "אליפלט"],
            AG: ["הקוממיות", "העמל", "כ\"ט בנובמבר", "יוספטל", "בנימין", "בלפור", "ז'בוטינסקי", "רוטשילד", "העצמאות", "מחרוזת", "הבעש\"ט", "איסקוב", "ארליך", "בלומפילד", "שלמה", "שנקר", "שחם", "דנקנר", "קרול", "פינסקר", "ת\"מ פ\"ת"],
            KARON_HUBS: ["אליפלט", "קריית אריה", "ת\"מ פ\"ת", "הקוממיות"] // תחנות לקרונות
        };

        // מקטעי מסילה לניקיון
        const TRACK_SEGMENTS = [
            "הקוממיות-העמל", "העמל-כ\"ט", "כ\"ט-יוספטל", "יוספטל-בנימין", "בנימין-בלפור", "בלפור-ז'בוטינסקי", 
            "ז'בוטינסקי-רוטשילד", "רוטשילד-העצמאות", "העצמאות-מחרוזת", "מחרוזת-הבעש\"ט", "הבעש\"ט-איסקוב",
            "איסקוב-ארליך", "ארליך-בלומפילד", "בלומפילד-שלמה", "שלמה-אליפלט", "שנקר-שחם", "שחם-בלינסון", 
            "בלינסון-דנקנר", "דנקנר-קרול", "קרול-פינסקר", "פינסקר-ת\"מ"
        ];

        // הגדרת משימות מדויקת לפי הטבלה
        const TASKS_DEF = {
            // תחנות
            ST_UG: { min: 60, label: "בקרת תחנה תת\"ק", color: "bg-station" },
            ST_AG: { min: 30, label: "בקרת תחנה", color: "bg-station-light" },
            ST_BEILINSON: { min: 45, label: "בקרת תחנה (בלינסון)", color: "bg-station-light" },
            
            // קרונות
            KARON: { min: 65, label: "בקרת קרונות", color: "bg-karon" },
            
            // מסילות
            TRACK_CLEAN: { min: 30, label: "ניקיון מסילה", color: "bg-track" },
            TRACK_FULL_R1: { min: 80, label: "מסלול מלא R1", color: "bg-track-long" },
            TRACK_FULL_R3: { min: 45, label: "מסלול מלא R3", color: "bg-track-long" },
            
            // אונבורד
            ONBOARD_R1: { min: 80, label: "אונבורד R1", color: "bg-onboard" }, // ממוצע 1:20
            ONBOARD_R3: { min: 40, label: "אונבורד R3", color: "bg-onboard" },
            
            // שירות
            CALL_CENTER: { min: 15, label: "מוקד שירות", color: "bg-service" },
            SERVICE_CENTER: { min: 45, label: "מרכז שירות", color: "bg-service" }
        };

        const CONTROLLERS = [
            { name: "אורי מייזלר", start: "07:00", end: "16:00" }, { name: "אינה טימופייב", start: "07:00", end: "16:00" },
            { name: "אלתי קראו", start: "08:00", end: "17:00" }, { name: "בוריס דולציגר", start: "06:00", end: "15:00" },
            { name: "בתיה אביה", start: "09:00", end: "18:00" }, { name: "דוד סייג", start: "07:00", end: "16:00" },
            { name: "הרצל שגב", start: "14:00", end: "23:00" }, { name: "יוני יוסף", start: "14:00", end: "23:00" },
            { name: "משה אליהו", start: "15:00", end: "23:00" }, { name: "ערן ניצן", start: "06:00", end: "15:00" },
            { name: "רון טוב", start: "07:00", end: "16:00" }, { name: "אברהם גברילביץ'", start: "08:00", end: "17:00" },
            { name: "גדי בן אור", start: "10:00", end: "19:00" }, { name: "יוני ניסן", start: "12:00", end: "21:00" }
        ];

        // --- 2. Logic Engine ---

        function runScheduler() {
            const container = document.getElementById('scheduleContainer');
            container.innerHTML = '';
            
            // בניית מאגר משימות גלובלי ליום הזה (Backlog)
            // זה מבטיח שכל תחנה מופיעה בדיוק פעם אחת ברשימה לביצוע
            let dailyTasks = buildDailyBacklog();
            
            // סטטיסטיקות
            let stats = { stations: new Set(), tracks: 0, longTracks: 0, onboard: 0, karonHours: 0, service: 0 };

            // ריצה על כל בקר
            CONTROLLERS.forEach(ctrl => {
                let currentMin = timeToMin(ctrl.start);
                let endMin = timeToMin(ctrl.end);
                let shiftHtml = '';

                // לולאת שיבוץ דקות
                while(currentMin < endMin - 15) {
                    // משיכת משימה מהמאגר
                    // הלוגיקה: נסה למצוא משימה שמתאימה לזמן שנשאר
                    let taskObj = pullTask(dailyTasks, endMin - currentMin);
                    
                    if (!taskObj) {
                        // אם נגמרו המשימות או אין זמן - הפסקה/סוף משמרת
                        break;
                    }

                    // עדכון סטטיסטיקות
                    updateStats(stats, taskObj);

                    // יצירת הבלוק הויזואלי
                    let widthPercent = (taskObj.duration / (17 * 60)) * 100; // יחסי ליום עבודה של 17 שעות (06-23)
                    // לשיפור התצוגה נשתמש בפיקסלים יחסיים
                    let pxWidth = taskObj.duration * 2; // 2px לדקה
                    
                    shiftHtml += `
                        <div class="task-block ${taskObj.color}" style="width: ${pxWidth}px" title="${taskObj.detail || taskObj.label}">
                            <div class="font-bold truncate">${taskObj.label}</div>
                            <div class="opacity-80">${taskObj.detail || ''}</div>
                        </div>
                    `;

                    currentMin += taskObj.duration;
                }

                // הוספת השורה לטבלה
                const row = `
                    <div class="timeline-row hover:bg-slate-50">
                        <div class="w-48 px-4 border-l flex-shrink-0">
                            <div class="font-bold text-slate-700 text-sm">${ctrl.name}</div>
                            <div class="text-xs text-slate-400">${ctrl.start} - ${ctrl.end}</div>
                        </div>
                        <div class="timeline-tracks px-1 items-center">
                            <!-- spacer for start time -->
                            <div style="width: ${(timeToMin(ctrl.start) - 360) * 2}px; flex-shrink: 0;"></div>
                            ${shiftHtml}
                        </div>
                    </div>
                `;
                container.innerHTML += row;
            });

            renderKPIs(stats);
            renderRuler();
        }

        function buildDailyBacklog() {
            let queue = [];

            // 1. חובה: תחנות (פעם אחת ביום לכל תחנה!)
            STATIONS.UG.forEach(s => queue.push({ ...TASKS_DEF.ST_UG, detail: s, type: 'STATION' }));
            STATIONS.AG.forEach(s => {
                if(s === "בלינסון") queue.push({ ...TASKS_DEF.ST_BEILINSON, detail: s, type: 'STATION' });
                else queue.push({ ...TASKS_DEF.ST_AG, detail: s, type: 'STATION' });
            });

            // 2. חובה: קרונות (4 שעות לכל תחנת קצה = כ-4 בקרות של 65 דק')
            STATIONS.KARON_HUBS.forEach(hub => {
                for(let i=0; i<4; i++) queue.push({ ...TASKS_DEF.KARON, detail: hub, type: 'KARON' });
            });

            // 3. מסלול מלא (לפחות פעם ביום מכל סוג)
            queue.push({ ...TASKS_DEF.TRACK_FULL_R1, type: 'LONG_TRACK' });
            queue.push({ ...TASKS_DEF.TRACK_FULL_R1, type: 'LONG_TRACK' });
            queue.push({ ...TASKS_DEF.TRACK_FULL_R3, type: 'LONG_TRACK' });

            // 4. שירות לנוסע
            queue.push({ ...TASKS_DEF.SERVICE_CENTER, detail: "שלמה", type: 'SERVICE' });
            queue.push({ ...TASKS_DEF.SERVICE_CENTER, detail: "קרליבך", type: 'SERVICE' });
            for(let i=0; i<3; i++) queue.push({ ...TASKS_DEF.CALL_CENTER, type: 'SERVICE' });

            // 5. ניקיון מסילות (מילוי)
            TRACK_SEGMENTS.forEach(seg => queue.push({ ...TASKS_DEF.TRACK_CLEAN, detail: seg, type: 'TRACK' }));

            // 6. אונבורד (מילוי נפח - הרבה)
            for(let i=0; i<30; i++) queue.push({ ...TASKS_DEF.ONBOARD_R1, type: 'ONBOARD' });
            for(let i=0; i<30; i++) queue.push({ ...TASKS_DEF.ONBOARD_R3, type: 'ONBOARD' });

            // ערבוב התור כדי ליצור גיוון, אבל נשמור על סדר עדיפויות באמצעות מיון ב-pullTask אם נרצה
            return queue.sort(() => Math.random() - 0.5);
        }

        function pullTask(queue, timeRemaining) {
            // חיפוש משימה שנכנסת בזמן שנותר
            // עדיפות לתחנות ושירות כדי לוודא כיסוי
            const idx = queue.findIndex(t => t.min <= timeRemaining);
            if(idx > -1) {
                return queue.splice(idx, 1)[0];
            }
            return null;
        }

        function updateStats(stats, task) {
            if(task.type === 'STATION') stats.stations.add(task.detail);
            if(task.type === 'TRACK') stats.tracks++;
            if(task.type === 'LONG_TRACK') stats.longTracks++;
            if(task.type === 'ONBOARD') stats.onboard++;
            if(task.type === 'KARON') stats.karonHours += (task.min / 60);
            if(task.type === 'SERVICE') stats.service++;
        }

        function renderKPIs(stats) {
            document.getElementById('kpiStations').innerText = `${stats.stations.size}/34`;
            document.getElementById('kpiTracks').innerText = stats.tracks;
            document.getElementById('kpiLongTracks').innerText = stats.longTracks;
            document.getElementById('kpiOnboard').innerText = stats.onboard;
            document.getElementById('kpiKaron').innerText = stats.karonHours.toFixed(1) + " ש'";
            document.getElementById('kpiService').innerText = stats.service;
        }

        // עזרים
        function timeToMin(t) { const [h,m] = t.split(':'); return h*60 + (+m); }
        
        function renderRuler() {
            const el = document.getElementById('timeRuler');
            el.innerHTML = '';
            for(let h=6; h<=23; h++) {
                el.innerHTML += `<div style="width: 120px; flex-shrink: 0; border-left: 1px solid #e2e8f0; padding-left: 4px;">${h}:00</div>`;
            }
        }

        window.onload = runScheduler;
    </script>
</body>
</html>
