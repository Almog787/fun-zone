<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Earth Breaker: Chaos Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #020205; font-family: 'Inter', sans-serif; user-select: none; }
        
        #start-screen {
            position: absolute; inset: 0; background: radial-gradient(circle, #1a0505 0%, #000 100%);
            z-index: 200; display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center;
        }
        #start-btn {
            padding: 25px 60px; font-size: 28px; background: #ff4b2b;
            color: white; border: none; border-radius: 50px; cursor: pointer; margin-top: 30px;
            box-shadow: 0 0 40px #ff4b2b; transition: all 0.3s; font-weight: 900;
        }

        #ui {
            position: absolute; inset: 0; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; z-index: 100;
        }
        
        #weapon-bar {
            display: flex; justify-content: center; gap: 15px; padding: 40px;
            pointer-events: auto; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        }
        .w-btn {
            width: 75px; height: 75px; background: rgba(20,20,25,0.9); border: 2px solid #333;
            border-radius: 20px; cursor: pointer; transition: 0.3s; color: white; font-size: 35px;
            display: flex; align-items: center; justify-content: center;
        }
        .w-btn.active { border-color: #ff4b2b; box-shadow: 0 0 20px #ff4b2b; transform: translateY(-10px); }

        #game-over {
            position: absolute; inset: 0; background: rgba(0,0,0,0.95);
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 300; color: #ff4b2b;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
</head>
<body>

    <div id="start-screen">
        <h1 style="font-size: 6vw; margin: 0; color: #ff4b2b; letter-spacing: 5px;">EARTH<br>BREAKER</h1>
        <p style="color: #666;">×¤×¨×§ ××ª ×”×¢×•×œ× ×œ×—×ª×™×›×•×ª</p>
        <button id="start-btn" onclick="initGame()">×”×ª×—×œ ×‘×”×©××“×”</button>
    </div>

    <div id="ui" style="display: none;">
        <div style="padding: 20px; text-align: center; color: #ff4b2b; font-weight: bold; font-size: 14px; letter-spacing: 2px;">
            ×¡×˜×˜×•×¡ ×¤×œ× ×˜×¨×™: <span id="status-text">×™×¦×™×‘</span>
        </div>
        <div id="weapon-bar">
            <button class="w-btn active" onclick="setW('nuke')">ğŸš€</button>
            <button class="w-btn" onclick="setW('asteroid')">â˜„ï¸</button>
            <button class="w-btn" onclick="setW('laser')">âš¡</button>
            <button class="w-btn" onclick="setW('monster')">ğŸ‘¾</button>
        </div>
    </div>

    <div id="game-over">
        <h1 style="font-size: 8vw;">PLANET DISSOLVED</h1>
        <button id="start-btn" onclick="location.reload()">×¦×•×¨ ×¢×•×œ× ×—×“×©</button>
    </div>

    <script>
        // --- ×§×•×œ×•×ª ---
        const sfx = {
            nuke: 'https://labs.phaser.io/assets/audio/SoundEffects/explosion.mp3',
            asteroid: 'https://labs.phaser.io/assets/audio/SoundEffects/explode1.wav',
            laser: 'https://labs.phaser.io/assets/audio/SoundEffects/alien_death.wav',
            monster: 'https://labs.phaser.io/assets/audio/monsters/zombie-3.mp3',
            chew: 'https://labs.phaser.io/assets/audio/SoundEffects/squit.mp3',
            bg: 'https://labs.phaser.io/assets/audio/tech/low_clipping_shimmer.mp3'
        };

        function play(key, vol = 1, pitch = 1) {
            const a = new Audio(sfx[key]);
            a.volume = vol;
            a.playbackRate = pitch;
            a.play();
        }

        // --- ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ---
        let scene, camera, renderer, earth, core, clouds;
        let weapon = 'nuke', isOver = false, shake = 0;
        let minions = [];
        let totalDamage = 0;
        const textureLoader = new THREE.TextureLoader();

        function initGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('ui').style.display = 'flex';
            play('bg', 0.3);

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 4;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // ××•×¨×•×ª
            const ambient = new THREE.AmbientLight(0x222233, 1.5);
            scene.add(ambient);
            const sun = new THREE.DirectionalLight(0xffffff, 1.2);
            sun.position.set(5, 3, 5);
            scene.add(sun);

            // ×œ×™×‘×ª ×××’××” ×¤× ×™××™×ª
            const coreGeo = new THREE.SphereGeometry(0.95, 32, 32);
            const coreMat = new THREE.MeshStandardMaterial({ 
                color: 0xff4400, 
                emissive: 0xff2200, 
                emissiveIntensity: 2,
                roughness: 1
            });
            core = new THREE.Mesh(coreGeo, coreMat);
            scene.add(core);

            // ×”×§×¨×•× ×”×—×™×¦×•× ×™ (×›×“×•×¨ ×”××¨×¥)
            const geo = new THREE.IcosahedronGeometry(1, 20); // ×¨×–×•×œ×•×¦×™×” ×’×‘×•×”×” ×××•×“ ×œ×¤×™×¨×•×§
            const mat = new THREE.MeshStandardMaterial({
                map: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_atmos_2048.jpg'),
                bumpMap: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_normal_2048.jpg'),
                bumpScale: 0.05,
                vertexColors: true,
                transparent: true
            });

            // ××¢×¨×›×ª ×§×•×“×§×•×“×™× ×œ×”×¨×¡
            const count = geo.attributes.position.count;
            geo.setAttribute('color', new THREE.BufferAttribute(new Float32Array(count * 3), 3));
            const colors = geo.attributes.color;
            for(let i=0; i<count; i++) colors.setXYZ(i, 1, 1, 1);

            earth = new THREE.Mesh(geo, mat);
            scene.add(earth);

            // ×¢× × ×™×
            clouds = new THREE.Mesh(
                new THREE.SphereGeometry(1.03, 64, 64),
                new THREE.MeshStandardMaterial({
                    map: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_clouds_1024.png'),
                    transparent: true, opacity: 0.4
                })
            );
            scene.add(clouds);

            // ×¨×§×¢ ×›×•×›×‘×™×
            const starGeo = new THREE.BufferGeometry();
            const starPos = [];
            for(let i=0; i<2000; i++) starPos.push((Math.random()-0.5)*100, (Math.random()-0.5)*100, (Math.random()-0.5)*100);
            starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
            scene.add(new THREE.Points(starGeo, new THREE.PointsMaterial({color: 0xffffff, size: 0.05})));

            window.addEventListener('pointerdown', onAttack);
            animate();
        }

        function setW(type) {
            weapon = type;
            document.querySelectorAll('.w-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function onAttack(e) {
            if(isOver) return;
            const mouse = new THREE.Vector2((e.clientX / window.innerWidth) * 2 - 1, -(e.clientY / window.innerHeight) * 2 + 1);
            const ray = new THREE.Raycaster();
            ray.setFromCamera(mouse, camera);
            const intersects = ray.intersectObject(earth);
            if(intersects.length > 0) fire(intersects[0].point);
        }

        function fire(pt) {
            if(weapon === 'nuke') effectNuke(pt);
            if(weapon === 'asteroid') effectAsteroid(pt);
            if(weapon === 'laser') effectLaser(pt);
            if(weapon === 'monster') effectMonster(pt);
        }

        // --- ××¤×§×˜×™× ×§×•×œ× ×•×¢×™×™× ---
        function createExplosion(pt, color, scale = 1) {
            // ×’×™×¦×™× ××”×™×¨×™×
            createParticles(pt, color, 50 * scale, 0.15, 0.8);
            // ×¢×©×Ÿ ×›×‘×“
            createParticles(pt, 0x111111, 30 * scale, 0.05, 2.0);
            
            // ×’×œ ×”×“×£ ×–×•×”×¨
            const ring = new THREE.Mesh(
                new THREE.RingGeometry(0.1, 0.2, 32),
                new THREE.MeshBasicMaterial({ color, side: THREE.DoubleSide, transparent: true, opacity: 0.7 })
            );
            ring.position.copy(pt);
            ring.lookAt(0,0,0);
            scene.add(ring);
            gsap.to(ring.scale, { x: 10 * scale, y: 10 * scale, duration: 0.6 });
            gsap.to(ring.material, { opacity: 0, duration: 0.6, onComplete: () => scene.remove(ring) });
            
            // ×ª××•×¨×ª ×¤×™×¦×•×¥
            const light = new THREE.PointLight(color, 10 * scale, 3);
            light.position.copy(pt);
            scene.add(light);
            gsap.to(light, { intensity: 0, duration: 0.4, onComplete: () => scene.remove(light) });
        }

        function createParticles(pt, color, count, speed, life) {
            const geo = new THREE.BufferGeometry();
            const pos = [], vel = [];
            for(let i=0; i<count; i++) {
                pos.push(pt.x, pt.y, pt.z);
                const v = new THREE.Vector3(Math.random()-0.5, Math.random()-0.5, Math.random()-0.5).normalize().multiplyScalar(speed * (0.5 + Math.random()));
                vel.push(v.x, v.y, v.z);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            const mat = new THREE.PointsMaterial({ color, size: 0.1, transparent: true, opacity: 1 });
            const p = new THREE.Points(geo, mat);
            scene.add(p);
            gsap.to(mat, { opacity: 0, duration: life, onComplete: () => scene.remove(p) });
            
            function frame() {
                const arr = geo.attributes.position.array;
                for(let i=0; i<count; i++) {
                    arr[i*3] += vel[i*3]; arr[i*3+1] += vel[i*3+1]; arr[i*3+2] += vel[i*3+2];
                }
                geo.attributes.position.needsUpdate = true;
                if(mat.opacity > 0) requestAnimationFrame(frame);
            }
            frame();
        }

        // --- × ×©×§×™× ---
        function effectNuke(pt) {
            play('nuke');
            createExplosion(pt, 0xffaa00, 3);
            decompose(pt, 0.5, 0.4); // × ×–×§ ×¨×¦×™× ×™
            shake = 0.8;
        }

        function effectAsteroid(pt) {
            const rock = new THREE.Mesh(new THREE.DodecahedronGeometry(0.15, 0), new THREE.MeshStandardMaterial({color: 0x444444}));
            rock.position.copy(pt).multiplyScalar(5);
            scene.add(rock);
            gsap.to(rock.position, { x: pt.x, y: pt.y, z: pt.z, duration: 0.5, ease: "power2.in", onComplete: () => {
                scene.remove(rock);
                play('asteroid');
                createExplosion(pt, 0xff4400, 1.5);
                decompose(pt, 0.35, 0.3);
                shake = 0.4;
            }});
        }

        function effectLaser(pt) {
            play('laser', 0.4, 1.5);
            const line = new THREE.Mesh(new THREE.CylinderGeometry(0.02, 0.02, 10), new THREE.MeshBasicMaterial({color: 0x00f3ff}));
            line.position.copy(pt).multiplyScalar(2);
            line.lookAt(pt);
            line.rotateX(Math.PI/2);
            scene.add(line);
            createExplosion(pt, 0x00f3ff, 0.5);
            decompose(pt, 0.15, 0.1);
            gsap.to(line.scale, { x:0, z:0, duration: 0.2, onComplete: () => scene.remove(line)});
        }

        function effectMonster(pt) {
            play('monster');
            // spawn minions
            for(let i=0; i<8; i++) {
                const minion = new THREE.Mesh(
                    new THREE.SphereGeometry(0.03, 8, 8),
                    new THREE.MeshBasicMaterial({color: 0x88ff00})
                );
                minion.position.copy(pt);
                // ×•×§×˜×•×¨ ×ª× ×•×¢×” ××§×¨××™ ×¢×œ ×¤× ×™ ×”×›×“×•×¨
                minion.userData.velocity = new THREE.Vector3(Math.random()-0.5, Math.random()-0.5, Math.random()-0.5).normalize().multiplyScalar(0.01);
                minion.userData.life = 200 + Math.random() * 300;
                scene.add(minion);
                minions.push(minion);
            }
        }

        // --- ×× ×•×¢ ×”×¤×™×¨×•×§ ×•×”×”×¨×¡ ---
        function decompose(pt, radius, strength) {
            const pos = earth.geometry.attributes.position;
            const cols = earth.geometry.attributes.color;
            const v = new THREE.Vector3();
            const localPt = earth.worldToLocal(pt.clone());

            for(let i=0; i<pos.count; i++) {
                v.set(pos.getX(i), pos.getY(i), pos.getZ(i));
                const d = v.distanceTo(localPt);
                
                if(d < radius) {
                    const power = (radius - d) / radius;
                    
                    // ×”×–×–×ª ×§×•×“×§×•×“×™× ×¤× ×™××” (×—×•×¨) ××• ×”×—×•×¦×” (×©×‘×¨×™×)
                    if(Math.random() > 0.3) {
                        v.multiplyScalar(1 - (power * strength)); // ××›×ª×©
                    } else {
                        v.multiplyScalar(1 + (power * strength * 2)); // ×—×ª×™×›×” ×©×¢×¤×”
                    }
                    
                    pos.setXYZ(i, v.x, v.y, v.z);
                    
                    // ×¦×‘×™×¢×” ×œ×××’××”
                    cols.setXYZ(i, 1, power * 0.5, 0); 
                    
                    totalDamage += power * 0.01;
                }
            }
            pos.needsUpdate = true;
            cols.needsUpdate = true;
            earth.geometry.computeVertexNormals();

            // ×¢×“×›×•×Ÿ ×¢× × ×™× - ×”× × ×¢×œ××™× ×‘××–×•×¨ ×”×¤×’×™×¢×”
            const cloudPos = clouds.geometry.attributes.position;
            for(let i=0; i<cloudPos.count; i++) {
                v.set(cloudPos.getX(i), cloudPos.getY(i), cloudPos.getZ(i));
                if(v.distanceTo(localPt) < radius) {
                    cloudPos.setXYZ(i, 0, 0, 0); // ×”×¢×œ××ª ×”×¢× × ×™×
                }
            }
            cloudPos.needsUpdate = true;

            updateStatus();
        }

        function updateStatus() {
            const status = document.getElementById('status-text');
            if(totalDamage > 50) {
                status.innerText = "×”×ª×¤×¨×§×•×ª ×¡×•×¤×™×ª";
                status.style.color = "red";
                if(totalDamage > 100) triggerEnd();
            } else if(totalDamage > 20) {
                status.innerText = "×§×¨×™×¡×ª ×§×¨×•×";
                status.style.color = "orange";
            }
        }

        function triggerEnd() {
            if(isOver) return;
            isOver = true;
            play('nuke', 1, 0.5);
            createExplosion(new THREE.Vector3(0,0,0), 0xffffff, 15);
            gsap.to(earth.scale, { x: 0, y: 0, z: 0, duration: 2 });
            gsap.to(core.scale, { x: 5, y: 5, z: 5, duration: 1, opacity: 0 });
            setTimeout(() => {
                document.getElementById('game-over').style.display = 'flex';
                document.getElementById('ui').style.display = 'none';
            }, 1500);
        }

        // --- ×× ×™××¦×™×” ---
        function animate() {
            requestAnimationFrame(animate);

            if(!isOver) {
                earth.rotation.y += 0.001;
                clouds.rotation.y += 0.0012;
                core.rotation.y -= 0.0005;

                // ×¢×“×›×•×Ÿ ×—×™×™×–×¨×™× ×§×˜× ×™×
                for(let i = minions.length - 1; i >= 0; i--) {
                    const m = minions[i];
                    m.position.add(m.userData.velocity);
                    // ×©××™×¨×” ×¢×œ ××™×§×•× ×¢×œ ×¤× ×™ ×”×›×“×•×¨
                    m.position.normalize().multiplyScalar(1.01); 
                    
                    // ×”×¨×¡ ×§×˜×Ÿ ×ª×•×š ×›×“×™ ×ª× ×•×¢×”
                    if(Math.random() > 0.9) {
                        decompose(m.position, 0.05, 0.02);
                        if(Math.random() > 0.8) play('chew', 0.1, 2);
                    }

                    m.userData.life--;
                    if(m.userData.life <= 0) {
                        createExplosion(m.position, 0x88ff00, 0.2);
                        scene.remove(m);
                        minions.splice(i, 1);
                    }
                }
            }

            // ×¨×¢×™×“×•×ª ××¦×œ××”
            if(shake > 0) {
                camera.position.x = (Math.random()-0.5) * shake;
                camera.position.y = (Math.random()-0.5) * shake;
                shake *= 0.95;
            } else {
                camera.position.x = 0; camera.position.y = 0;
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
